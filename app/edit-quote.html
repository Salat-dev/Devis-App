<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
  <title>Modifier Devis - Devis App</title>
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; } 

    :root {
      --orange: #F97316;
      --orange-dark: #EA6C0A;
      --orange-light: #FEF3E7;
      --gray-50: #F9FAFB;
      --gray-100: #F3F4F6;
      --gray-200: #E5E7EB;
      --gray-300: #D1D5DB;
      --gray-400: #9CA3AF;
      --gray-500: #6B7280;
      --gray-600: #4B5563;
      --gray-700: #374151;
      --gray-800: #1F2937;
      --gray-900: #111827;
      --green: #10B981;
      --green-light: #D1FAE5;
      --blue: #3B82F6;
      --blue-light: #EFF6FF;
      --red: #EF4444;
      --red-light: #FFF1F1;
      --yellow: #F59E0B;
      --yellow-light: #FFFBEB;
      --white: #FFFFFF;
      --whatsapp: #25D366;
    }

    body { font-family: 'DM Sans', sans-serif; background: var(--gray-100); min-height: 100vh; display: flex; }

    /* ── Sidebar ── */
    .sidebar { width: 260px; min-width: 260px; background: var(--gray-900); display: flex; flex-direction: column; height: 100vh; position: sticky; top: 0; }
    .sidebar-logo { padding: 24px 20px; border-bottom: 1px solid rgba(255,255,255,0.07); display: flex; align-items: center; gap: 10px; }
    .sidebar-logo-icon { width: 36px; height: 36px; background: var(--orange); border-radius: 10px; display: flex; align-items: center; justify-content: center; }
    .sidebar-logo span { font-family: 'Syne', sans-serif; font-size: 18px; font-weight: 800; color: white; }
    .sidebar-nav { flex: 1; padding: 16px 12px; display: flex; flex-direction: column; gap: 4px; }
    .nav-section-label { font-size: 10px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; color: rgba(255,255,255,0.3); padding: 12px 12px 6px; }
    .nav-link { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius: 10px; color: rgba(255,255,255,0.55); text-decoration: none; font-size: 14px; font-weight: 500; transition: all 0.2s; }
    .nav-link:hover { background: rgba(255,255,255,0.07); color: rgba(255,255,255,0.9); }
    .nav-link.active { background: rgba(249,115,22,0.15); color: var(--orange); }
    .sidebar-footer { padding: 16px 12px; border-top: 1px solid rgba(255,255,255,0.07); }
    .user-card { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius: 10px; margin-bottom: 8px; background: rgba(255,255,255,0.05); }
    .user-avatar { width: 34px; height: 34px; border-radius: 50%; background: var(--orange); display: flex; align-items: center; justify-content: center; font-family: 'Syne', sans-serif; font-size: 13px; font-weight: 700; color: white; flex-shrink: 0; }
    .user-name { font-size: 13px; font-weight: 600; color: white; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .user-role { font-size: 11px; color: rgba(255,255,255,0.4); }
    .btn-logout { width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px; padding: 9px; border-radius: 10px; background: rgba(239,68,68,0.1); color: #F87171; font-family: 'DM Sans', sans-serif; font-size: 13px; font-weight: 600; border: 1px solid rgba(239,68,68,0.2); cursor: pointer; transition: all 0.2s; }
    .btn-logout:hover { background: rgba(239,68,68,0.2); color: #FCA5A5; }

    /* ── Main ── */
    .main { flex: 1; overflow-y: auto; padding: 32px 36px; }

    .back-link { display: inline-flex; align-items: center; gap: 6px; font-size: 13px; font-weight: 600; color: var(--gray-500); text-decoration: none; transition: color 0.2s; margin-bottom: 14px; }
    .back-link:hover { color: var(--orange); }

    /* ── Form ── */
    .form-title { font-family: 'Syne', sans-serif; font-size: 24px; font-weight: 800; color: var(--gray-800); margin-bottom: 24px; }
    .form-group { margin-bottom: 20px; }
    .form-label { font-size: 13px; font-weight: 600; color: var(--gray-700); margin-bottom: 6px; display: block; }
    .form-input { width: 100%; padding: 10px 14px; border: 1.5px solid var(--gray-200); border-radius: 10px; font-size: 14px; color: var(--gray-800); background: var(--white); transition: all 0.2s; }
    .form-input:focus { border-color: var(--orange); outline: none; }
    .form-select { width: 100%; padding: 10px 14px; border: 1.5px solid var(--gray-200); border-radius: 10px; font-size: 14px; color: var(--gray-800); background: var(--white); transition: all 0.2s; appearance: none; }
    .form-select:focus { border-color: var(--orange); outline: none; }
    .form-textarea { width: 100%; padding: 10px 14px; border: 1.5px solid var(--gray-200); border-radius: 10px; font-size: 14px; color: var(--gray-800); background: var(--white); transition: all 0.2s; min-height: 100px; resize: vertical; }
    .form-textarea:focus { border-color: var(--orange); outline: none; }

    /* ── Items Table ── */
    .items-table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
    .items-table th { padding: 10px; background: var(--gray-100); text-align: left; font-size: 13px; font-weight: 600; color: var(--gray-700); border-bottom: 1.5px solid var(--gray-200); }
    .items-table td { padding: 10px; border-bottom: 1px solid var(--gray-100); }
    .items-table input { width: 100%; padding: 8px; border: 1px solid var(--gray-200); border-radius: 6px; font-size: 14px; }
    .items-table .right { text-align: right; }
    .btn-add-item { display: inline-flex; align-items: center; gap: 6px; padding: 8px 16px; border-radius: 10px; background: var(--orange-light); color: var(--orange); font-weight: 600; border: none; cursor: pointer; transition: all 0.2s; }
    .btn-add-item:hover { background: var(--orange); color: white; }
    .btn-remove-item { padding: 6px 10px; border-radius: 6px; background: var(--red-light); color: var(--red); border: none; cursor: pointer; transition: all 0.2s; }
    .btn-remove-item:hover { background: var(--red); color: white; }

    /* ── Totals ── */
    .totals { text-align: right; margin-bottom: 20px; }
    .totals p { font-size: 14px; color: var(--gray-600); margin-bottom: 4px; }
    .totals .total { font-size: 18px; font-weight: 800; color: var(--orange); }

    /* ── Buttons ── */
    .form-buttons { display: flex; gap: 10px; }
    .btn-save { padding: 10px 20px; border-radius: 10px; background: var(--orange); color: white; font-weight: 700; border: none; cursor: pointer; transition: all 0.2s; }
    .btn-save:hover { background: var(--orange-dark); }
    .btn-cancel { padding: 10px 20px; border-radius: 10px; background: var(--gray-100); color: var(--gray-700); font-weight: 600; border: 1.5px solid var(--gray-200); cursor: pointer; transition: all 0.2s; }
    .btn-cancel:hover { background: var(--gray-200); }

    /* ── Toast ── */
    .toast { position: fixed; bottom: 28px; right: 28px; padding: 14px 20px; border-radius: 12px; font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 10px; box-shadow: 0 8px 32px rgba(0,0,0,0.12); animation: toastIn 0.3s ease; z-index: 999; }
    .toast.success { background: var(--green); color: white; }
    .toast.error   { background: var(--red);   color: white; }
    @keyframes toastIn { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }

    @media (max-width: 900px) { .sidebar { display: none; } .main { padding: 20px 16px; } }
  </style>
</head>

<body>

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-logo">
      <div class="sidebar-logo-icon">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
      </div>
      <span>Devis App</span>
    </div>
    <nav class="sidebar-nav">
      <span class="nav-section-label">Menu</span>
      <a href="dashboard.html" class="nav-link">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
        Dashboard
      </a>
      <a href="quotes.html" class="nav-link active">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
        Devis
      </a>
      <a href="clients.html" class="nav-link">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>
        Clients
      </a>
      <span class="nav-section-label" style="margin-top:8px;">Compte</span>
      <a href="settings.html" class="nav-link">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
        Paramètres
      </a>
    </nav>
    <div class="sidebar-footer">
      <div class="user-card">
        <div class="user-avatar" id="userAvatar">?</div>
        <div>
          <div class="user-name" id="sidebarName">Chargement...</div>
          <div class="user-role" id="sidebarCompany">—</div>
        </div>
      </div>
      <button class="btn-logout" id="logoutBtn">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
        Déconnexion
      </button>
    </div>
  </aside>

  <!-- Main -->
  <main class="main">

    <a href="view-quote.html?id=${quoteId}" class="back-link">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="15 18 9 12 15 6"/></svg>
      Retour au devis
    </a>

    <h1 class="form-title">Modifier le Devis</h1>

    <form id="editQuoteForm">
      <div class="form-group">
        <label class="form-label" for="quoteNumber">Numéro de devis</label>
        <input type="text" id="quoteNumber" class="form-input" required>
      </div>

      <div class="form-group">
        <label class="form-label" for="createdAt">Date</label>
        <input type="date" id="createdAt" class="form-input" required>
      </div>

      <div class="form-group">
        <label class="form-label" for="clientId">Client</label>
        <select id="clientId" class="form-select" required>
          <option value="">Sélectionnez un client</option>
        </select>
      </div>

      <div class="form-group">
        <label class="form-label">Lignes</label>
        <table class="items-table">
          <thead>
            <tr>
              <th style="width:50%">Description</th>
              <th style="width:14%">Quantité</th>
              <th style="width:18%">Prix unitaire</th>
              <th style="width:18%">Total</th>
              <th style="width:5%"></th>
            </tr>
          </thead>
          <tbody id="itemsBody">
            <!-- Rows will be added dynamically -->
          </tbody>
        </table>
        <button type="button" class="btn-add-item" id="addItemBtn">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
          Ajouter une ligne
        </button>
      </div>

      <div class="form-group">
        <label class="form-label" for="taxRate">Taux TVA (%)</label>
        <input type="number" id="taxRate" class="form-input" min="0" step="0.01" required>
      </div>

      <div class="totals">
        <p>Sous-total HT: <span id="subtotal">0 XOF</span></p>
        <p>TVA: <span id="taxAmount">0 XOF</span></p>
        <p class="total">Total TTC: <span id="totalAmount">0 XOF</span></p>
      </div>

      <div class="form-group">
        <label class="form-label" for="notes">Notes</label>
        <textarea id="notes" class="form-textarea"></textarea>
      </div>

      <div class="form-buttons">
        <button type="submit" class="btn-save">Enregistrer</button>
        <button type="button" class="btn-cancel" id="cancelEdit">Annuler</button>
      </div>
    </form>

  </main>

<script type="module">
import { createClient } from 'https://esm.sh/@supabase/supabase-js'

const supabase = createClient(
  'https://xeezdzbotsblzclnmnxg.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhlZXpkemJvdHNibHpjbG5tbnhnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0NDk3NTQsImV4cCI6MjA4NjAyNTc1NH0.RHIGavm6M9WCR6nve1Iz_JKFeQRlpRCU2FNAr9E02PM'
)

const quoteId = new URLSearchParams(window.location.search).get('id')
let quoteData = null
let clients = []

// ── Toast ─────────────────────────────────────────────────────────────────────
function showToast(msg, type = 'success') {
  const t = document.createElement('div')
  t.className = `toast ${type}`
  t.innerHTML = type === 'success' ? `✅ ${msg}` : `❌ ${msg}`
  document.body.appendChild(t)
  setTimeout(() => t.remove(), 3500)
}

// ── Init ─────────────────────────────────────────────────────────────────────
async function init() {
  if (!quoteId) { window.location.href = 'quotes.html'; return }

  const { data: { session } } = await supabase.auth.getSession()
  if (!session) { window.location.href = 'login.html'; return }

  await loadUserProfile(session.user.id)
  await loadClients()
  await loadQuote()
}

// ── Profil sidebar ────────────────────────────────────────────────────────────
async function loadUserProfile(userId) {
  const { data } = await supabase.from('profiles').select('first_name, last_name, company').eq('id', userId).single()
  if (data) {
    const initials = [data.first_name?.[0], data.last_name?.[0]].filter(Boolean).join('').toUpperCase() || 'U'
    document.getElementById('userAvatar').textContent = initials
    document.getElementById('sidebarName').textContent = [data.first_name, data.last_name].filter(Boolean).join(' ') || 'Utilisateur'
    document.getElementById('sidebarCompany').textContent = data.company || 'Mon entreprise'
  }
}

// ── Chargement clients ────────────────────────────────────────────────────────
async function loadClients() {
  const { data } = await supabase.from('clients').select('id, full_name')
  clients = data || []
  const select = document.getElementById('clientId')
  clients.forEach(client => {
    const option = document.createElement('option')
    option.value = client.id
    option.textContent = client.full_name
    select.appendChild(option)
  })
}

// ── Chargement du devis ───────────────────────────────────────────────────────
async function loadQuote() {
  const { data } = await supabase.from('quotes').select('*, quote_items(*)').eq('id', quoteId).single()
  if (!data) {
    showToast('Devis introuvable.', 'error')
    setTimeout(() => window.location.href = 'quotes.html', 2000)
    return
  }

  quoteData = data
  document.getElementById('quoteNumber').value = data.quote_number || ''
  document.getElementById('createdAt').value = data.created_at ? new Date(data.created_at).toISOString().split('T')[0] : ''
  document.getElementById('clientId').value = data.client_id || ''
  document.getElementById('taxRate').value = data.tax_rate || 0
  document.getElementById('notes').value = data.notes || ''

  const itemsBody = document.getElementById('itemsBody')
  itemsBody.innerHTML = ''
  data.quote_items.forEach(item => addItemRow(item))
  if (!data.quote_items.length) addItemRow()
  calculateTotals()
}

// ── Ajout d'une ligne ─────────────────────────────────────────────────────────
function addItemRow(item = { description: '', quantity: 1, unit_price: 0 }) {
  const row = document.createElement('tr')
  row.innerHTML = `
    <td><input type="text" class="item-desc" value="${item.description}"></td>
    <td><input type="number" class="item-qty" value="${item.quantity}" min="1"></td>
    <td><input type="number" class="item-price" value="${item.unit_price}" min="0" step="0.01"></td>
    <td class="right item-total">0 XOF</td>
    <td><button type="button" class="btn-remove-item">X</button></td>
  `
  document.getElementById('itemsBody').appendChild(row)

  row.querySelector('.item-desc').addEventListener('input', calculateTotals)
  row.querySelector('.item-qty').addEventListener('input', calculateTotals)
  row.querySelector('.item-price').addEventListener('input', calculateTotals)
  row.querySelector('.btn-remove-item').addEventListener('click', () => { row.remove(); calculateTotals() })
}

// ── Calcul des totaux ─────────────────────────────────────────────────────────
function calculateTotals() {
  let subtotal = 0
  document.querySelectorAll('#itemsBody tr').forEach(row => {
    const qty = parseFloat(row.querySelector('.item-qty').value) || 0
    const price = parseFloat(row.querySelector('.item-price').value) || 0
    const total = qty * price
    row.querySelector('.item-total').textContent = new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'XOF' }).format(total)
    subtotal += total
  })

  const taxRate = parseFloat(document.getElementById('taxRate').value) || 0
  const taxAmount = subtotal * (taxRate / 100)
  const totalAmount = subtotal + taxAmount

  document.getElementById('subtotal').textContent = new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'XOF' }).format(subtotal)
  document.getElementById('taxAmount').textContent = new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'XOF' }).format(taxAmount)
  document.getElementById('totalAmount').textContent = new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'XOF' }).format(totalAmount)
}

// ── Événements ────────────────────────────────────────────────────────────────
document.getElementById('addItemBtn').addEventListener('click', () => addItemRow())
document.getElementById('taxRate').addEventListener('input', calculateTotals)

document.getElementById('editQuoteForm').addEventListener('submit', async function(e) {
  e.preventDefault()

  const quote = {
    quote_number: document.getElementById('quoteNumber').value,
    created_at: document.getElementById('createdAt').value,
    client_id: document.getElementById('clientId').value,
    tax_rate: parseFloat(document.getElementById('taxRate').value),
    notes: document.getElementById('notes').value,
    subtotal: parseFloat(document.getElementById('subtotal').textContent.replace(/[^0-9.-]+/g,"")) || 0,
    tax_amount: parseFloat(document.getElementById('taxAmount').textContent.replace(/[^0-9.-]+/g,"")) || 0,
    total_amount: parseFloat(document.getElementById('totalAmount').textContent.replace(/[^0-9.-]+/g,"")) || 0
  }

  const { error: quoteError } = await supabase.from('quotes').update(quote).eq('id', quoteId)
  if (quoteError) { showToast('Erreur mise à jour devis', 'error'); return }

  // Supprimer anciennes lignes
  await supabase.from('quote_items').delete().eq('quote_id', quoteId)

  // Ajouter nouvelles lignes
  const items = []
  document.querySelectorAll('#itemsBody tr').forEach(row => {
    const qty = parseFloat(row.querySelector('.item-qty').value) || 0
    const price = parseFloat(row.querySelector('.item-price').value) || 0
    if (qty > 0 && price > 0) {
      items.push({
        quote_id: quoteId,
        description: row.querySelector('.item-desc').value,
        quantity: qty,
        unit_price: price,
        total: qty * price
      })
    }
  })

  if (items.length) {
    const { error: itemsError } = await supabase.from('quote_items').insert(items)
    if (itemsError) { showToast('Erreur mise à jour lignes', 'error'); return }
  }

  showToast('Devis mis à jour !')
  setTimeout(() => window.location.href = `view-quote.html?id=${quoteId}`, 1200)
})

document.getElementById('cancelEdit').addEventListener('click', () => {
  window.location.href = `view-quote.html?id=${quoteId}`
})

// ── Logout ────────────────────────────────────────────────────────────────────
document.getElementById('logoutBtn').addEventListener('click', async () => {
  await supabase.auth.signOut()
  window.location.href = 'login.html'
})

init()
</script>

</body>
</html>