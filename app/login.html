<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
<title>Connexion - Devis App</title>
<link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --orange: #F97316;
    --orange-dark: #EA6C0A;
    --orange-light: #FEF3E7;
    --gray-50: #F9FAFB;
    --gray-100: #F3F4F6;
    --gray-200: #E5E7EB;
    --gray-400: #9CA3AF;
    --gray-600: #4B5563;
    --gray-800: #1F2937;
    --green: #10B981;
    --red: #EF4444;
    --white: #FFFFFF;
  }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--gray-100);
    min-height: 100vh;
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 24px;
    position: relative;
    overflow: hidden;
  }

  body::before {
    content: '';
    position: fixed;
    top: -200px; right: -200px;
    width: 600px; height: 600px;
    border-radius: 50%;
    background: radial-gradient(circle, rgba(249,115,22,0.12) 0%, transparent 70%);
    pointer-events: none;
  }
  body::after {
    content: '';
    position: fixed;
    bottom: -150px; left: -150px;
    width: 400px; height: 400px;
    border-radius: 50%;
    background: radial-gradient(circle, rgba(249,115,22,0.08) 0%, transparent 70%);
    pointer-events: none;
  }

  .card {
    background: var(--white);
    border-radius: 24px;
    padding: 40px 44px;
    width: 100%;
    max-width: 460px;
    box-shadow: 0 4px 6px rgba(0,0,0,0.04), 0 20px 60px rgba(0,0,0,0.08);
    animation: slideUp 0.4s ease;
  }

  @keyframes slideUp {
    from { opacity: 0; transform: translateY(20px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  .header-badge {
    display: inline-flex;
    align-items: center;
    gap: 6px;
    background: var(--orange-light);
    color: var(--orange);
    font-family: 'Syne', sans-serif;
    font-size: 11px;
    font-weight: 700;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    padding: 5px 12px;
    border-radius: 100px;
    margin-bottom: 16px;
  }

  h1 {
    font-family: 'Syne', sans-serif;
    font-size: 26px;
    font-weight: 800;
    color: var(--gray-800);
    margin-bottom: 6px;
    line-height: 1.2;
  }

  .subtitle {
    font-size: 14px;
    color: var(--gray-400);
    margin-bottom: 32px;
  }

  /* Champs */
  .field-group {
    display: flex;
    flex-direction: column;
    gap: 6px;
    margin-bottom: 16px;
  }
  .field-group label {
    font-size: 12px;
    font-weight: 600;
    color: var(--gray-600);
    letter-spacing: 0.02em;
  }

  .input-wrap {
    position: relative;
  }
  .input-wrap svg {
    position: absolute;
    left: 13px;
    top: 50%;
    transform: translateY(-50%);
    color: var(--gray-400);
    pointer-events: none;
  }

  input {
    width: 100%;
    border: 1.5px solid var(--gray-200);
    border-radius: 10px;
    padding: 11px 14px 11px 40px;
    font-family: 'DM Sans', sans-serif;
    font-size: 14px;
    color: var(--gray-800);
    background: var(--gray-50);
    transition: border-color 0.2s, box-shadow 0.2s, background 0.2s;
    outline: none;
  }
  input::placeholder { color: var(--gray-400); }
  input:focus {
    border-color: var(--orange);
    background: var(--white);
    box-shadow: 0 0 0 3px rgba(249,115,22,0.1);
  }
  input.error {
    border-color: var(--red);
    box-shadow: 0 0 0 3px rgba(239,68,68,0.1);
  }

  /* Toggle password */
  .toggle-password {
    position: absolute;
    right: 13px;
    top: 50%;
    transform: translateY(-50%);
    background: none;
    border: none;
    cursor: pointer;
    color: var(--gray-400);
    padding: 0;
    display: flex;
    align-items: center;
    transition: color 0.2s;
  }
  .toggle-password:hover { color: var(--gray-600); }

  /* Lien mot de passe oublié */
  .forgot-link {
    display: block;
    text-align: right;
    font-size: 12px;
    font-weight: 600;
    color: var(--orange);
    text-decoration: none;
    margin-top: -8px;
    margin-bottom: 24px;
    transition: color 0.2s;
  }
  .forgot-link:hover { color: var(--orange-dark); }

  /* Bouton principal */
  .btn-submit {
    width: 100%;
    background: var(--orange);
    color: var(--white);
    font-family: 'DM Sans', sans-serif;
    font-size: 15px;
    font-weight: 700;
    border: none;
    cursor: pointer;
    border-radius: 10px;
    padding: 13px 24px;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    box-shadow: 0 4px 12px rgba(249,115,22,0.3);
  }
  .btn-submit:hover { background: var(--orange-dark); transform: translateY(-1px); box-shadow: 0 6px 16px rgba(249,115,22,0.35); }
  .btn-submit:active { transform: translateY(0); }
  .btn-submit:disabled { opacity: 0.65; cursor: not-allowed; transform: none; }

  /* Message */
  #message {
    font-size: 13px;
    text-align: center;
    margin-top: 16px;
    min-height: 20px;
    border-radius: 8px;
    padding: 8px 12px;
    line-height: 1.5;
  }
  #message:not(:empty) { background: var(--gray-50); }
  #message.success { color: var(--green); background: #F0FDF4; }
  #message.error   { color: var(--red);   background: #FFF1F1; }

  /* Divider */
  .divider {
    display: flex;
    align-items: center;
    gap: 12px;
    margin: 24px 0;
  }
  .divider::before, .divider::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--gray-200);
  }
  .divider span {
    font-size: 12px;
    color: var(--gray-400);
    font-weight: 500;
  }

  /* Footer */
  .footer-text {
    text-align: center;
    font-size: 13px;
    color: var(--gray-400);
  }
  .footer-text a {
    color: var(--orange);
    font-weight: 700;
    text-decoration: none;
  }
  .footer-text a:hover { color: var(--orange-dark); }

  /* Loader */
  @keyframes spin { to { transform: rotate(360deg); } }
  .spinner {
    width: 16px; height: 16px;
    border: 2px solid rgba(255,255,255,0.4);
    border-top-color: white;
    border-radius: 50%;
    animation: spin 0.7s linear infinite;
  }

  @media (max-width: 480px) {
    .card { padding: 28px 20px; }
    h1 { font-size: 22px; }
  }

  /* Smartwatch & ultra-small screens */
  @media (max-width: 200px) {
    body { padding: 8px; align-items: flex-start; }
    body::before, body::after { display: none; }
    .card { padding: 14px 12px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
    .header-badge { font-size: 9px; padding: 3px 8px; margin-bottom: 8px; }
    h1 { font-size: 15px; margin-bottom: 4px; }
    .subtitle { font-size: 10px; margin-bottom: 14px; }
    .field-group { margin-bottom: 10px; gap: 4px; }
    .field-group label { font-size: 10px; }
    input { padding: 8px 10px 8px 30px; font-size: 11px; border-radius: 7px; }
    .input-wrap svg { width: 12px; height: 12px; left: 9px; }
    .toggle-password { right: 8px; }
    .toggle-password svg { width: 12px; height: 12px; }
    .forgot-link { font-size: 10px; }
    .btn-submit { padding: 10px; font-size: 12px; border-radius: 8px; }
    #message { font-size: 10px; padding: 6px 10px; margin-top: 10px; }
    .divider { margin: 12px 0; }
    .divider span { font-size: 10px; }
    .footer-text { font-size: 11px; }
  }
</style>
</head>

<body>
<div class="card">

  <div class="header-badge">
    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
    Devis App
  </div>

  <h1>Bon retour !</h1>
  <p class="subtitle">Connectez-vous pour gérer vos devis.</p>

  <form id="loginForm" novalidate>

    <div class="field-group">
      <label>Email</label>
      <div class="input-wrap">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
        <input id="email" type="email" placeholder="nom@entreprise.com" required autocomplete="email">
      </div>
    </div>

    <div class="field-group">
      <label>Mot de passe</label>
      <div class="input-wrap">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0110 0v4"/></svg>
        <input id="password" type="password" placeholder="••••••••" required autocomplete="current-password">
        <button type="button" class="toggle-password" id="togglePassword" aria-label="Afficher le mot de passe">
          <svg id="eyeIcon" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
        </button>
      </div>
    </div>

    <a href="forgot-password.html" class="forgot-link">Mot de passe oublié ?</a>

    <button type="submit" id="loginBtn" class="btn-submit">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M15 3h4a2 2 0 012 2v14a2 2 0 01-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></svg>
      Se connecter
    </button>

  </form>

  <p id="message"></p>

  <div class="divider"><span>ou</span></div>

  <p class="footer-text">
    Pas encore de compte ?
    <a href="register.html">Inscrivez-vous</a>
  </p>

</div>

<script type="module">
import { createClient } from 'https://esm.sh/@supabase/supabase-js'

// ─── Client Supabase ──────────────────────────────────────────────────────────
const supabase = createClient(
  'https://xeezdzbotsblzclnmnxg.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhlZXpkemJvdHNibHpjbG5tbnhnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0NDk3NTQsImV4cCI6MjA4NjAyNTc1NH0.RHIGavm6M9WCR6nve1Iz_JKFeQRlpRCU2FNAr9E02PM'
)

// ─── DOM ──────────────────────────────────────────────────────────────────────
const loginForm    = document.getElementById("loginForm")
const loginBtn     = document.getElementById("loginBtn")
const messageEl    = document.getElementById("message")
const toggleBtn    = document.getElementById("togglePassword")
const passwordInput = document.getElementById("password")

// ─── Toggle affichage mot de passe ────────────────────────────────────────────
toggleBtn.addEventListener("click", () => {
  const isPassword = passwordInput.type === "password"
  passwordInput.type = isPassword ? "text" : "password"
  toggleBtn.innerHTML = isPassword
    ? `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.94 17.94A10.07 10.07 0 0112 20c-7 0-11-8-11-8a18.45 18.45 0 015.06-5.94M9.9 4.24A9.12 9.12 0 0112 4c7 0 11 8 11 8a18.5 18.5 0 01-2.16 3.19m-6.72-1.07a3 3 0 11-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/></svg>`
    : `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>`
})

// ─── Messages UI ──────────────────────────────────────────────────────────────
function showMessage(text, type = "error") {
  messageEl.textContent = text
  messageEl.className = type
}
function clearMessage() {
  messageEl.textContent = ""
  messageEl.className = ""
}

function setLoading(loading) {
  loginBtn.disabled = loading
  loginBtn.innerHTML = loading
    ? `<span class="spinner"></span> Connexion en cours...`
    : `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M15 3h4a2 2 0 012 2v14a2 2 0 01-2 2h-4"/><polyline points="10 17 15 12 10 7"/><line x1="15" y1="12" x2="3" y2="12"/></svg> Se connecter`
}

// ─── Synchronisation du profil en attente ─────────────────────────────────────
// Après confirmation email, les données du profil sont dans localStorage.
// On les envoie dans profiles via UPDATE maintenant que l'user est connecté.
async function syncPendingProfile(userId) {
  try {
    const pending = localStorage.getItem("pending_profile")
    if (!pending) return

    const { id, ...profileData } = JSON.parse(pending)

    const { error } = await supabase
      .from("profiles")
      .update(profileData)
      .eq("id", userId)

    if (error) {
      console.error("Erreur sync profil:", error)
    } else {
      localStorage.removeItem("pending_profile")
      console.log("Profil synchronisé avec succès ✓")
    }
  } catch (err) {
    console.error("Erreur parsing pending_profile:", err)
    localStorage.removeItem("pending_profile")
  }
}

// ─── Soumission ───────────────────────────────────────────────────────────────
loginForm.addEventListener("submit", async (e) => {
  e.preventDefault()
  clearMessage()

  const email    = document.getElementById("email").value.trim()
  const password = passwordInput.value

  // Validation basique
  if (!email || !password) {
    showMessage("Veuillez remplir tous les champs.")
    return
  }

  setLoading(true)

  const { data, error } = await supabase.auth.signInWithPassword({ email, password })

  if (error) {
    console.error("Login error:", error)

    // Messages d'erreur lisibles en français
    let msg = "Erreur de connexion."
    if (error.message.toLowerCase().includes("invalid login") ||
        error.message.toLowerCase().includes("invalid credentials")) {
      msg = "Email ou mot de passe incorrect."
    } else if (error.message.toLowerCase().includes("email not confirmed")) {
      msg = "Email non confirmé. Vérifiez votre boîte mail et cliquez sur le lien d'activation."
    } else if (error.message.toLowerCase().includes("too many requests")) {
      msg = "Trop de tentatives. Réessayez dans quelques minutes."
    } else {
      msg = error.message
    }

    showMessage(msg)
    setLoading(false)
    return
  }

  // ── Connexion réussie ──────────────────────────────────────────────────────
  showMessage("Connexion réussie ! Redirection...", "success")

  // Synchronise le profil en attente si nécessaire
  if (data.user) {
    await syncPendingProfile(data.user.id)
  }

  setTimeout(() => {
    window.location.href = "dashboard.html"
  }, 1200)
})
</script>

</body>
</html>