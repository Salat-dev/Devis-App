<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
  <title>Voir Devis - Devis App</title>
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --orange: #F97316;
      --orange-dark: #EA6C0A;
      --orange-light: #FEF3E7;
      --gray-50: #F9FAFB;
      --gray-100: #F3F4F6;
      --gray-200: #E5E7EB;
      --gray-300: #D1D5DB;
      --gray-400: #9CA3AF;
      --gray-500: #6B7280;
      --gray-600: #4B5563;
      --gray-700: #374151;
      --gray-800: #1F2937;
      --gray-900: #111827;
      --green: #10B981;
      --green-light: #D1FAE5;
      --blue: #3B82F6;
      --blue-light: #EFF6FF;
      --red: #EF4444;
      --red-light: #FFF1F1;
      --yellow: #F59E0B;
      --yellow-light: #FFFBEB;
      --white: #FFFFFF;
      --whatsapp: #25D366;
    }

    body { font-family: 'DM Sans', sans-serif; background: var(--gray-100); min-height: 100vh; display: flex; }

    /* ‚îÄ‚îÄ Sidebar ‚îÄ‚îÄ */
    .sidebar { width: 260px; min-width: 260px; background: var(--gray-900); display: flex; flex-direction: column; height: 100vh; position: sticky; top: 0; }
    .sidebar-logo { padding: 24px 20px; border-bottom: 1px solid rgba(255,255,255,0.07); display: flex; align-items: center; gap: 10px; }
    .sidebar-logo-icon { width: 36px; height: 36px; background: var(--orange); border-radius: 10px; display: flex; align-items: center; justify-content: center; }
    .sidebar-logo span { font-family: 'Syne', sans-serif; font-size: 18px; font-weight: 800; color: white; }
    .sidebar-nav { flex: 1; padding: 16px 12px; display: flex; flex-direction: column; gap: 4px; }
    .nav-section-label { font-size: 10px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; color: rgba(255,255,255,0.3); padding: 12px 12px 6px; }
    .nav-link { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius: 10px; color: rgba(255,255,255,0.55); text-decoration: none; font-size: 14px; font-weight: 500; transition: all 0.2s; }
    .nav-link:hover { background: rgba(255,255,255,0.07); color: rgba(255,255,255,0.9); }
    .nav-link.active { background: rgba(249,115,22,0.15); color: var(--orange); }
    .sidebar-footer { padding: 16px 12px; border-top: 1px solid rgba(255,255,255,0.07); }
    .user-card { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius: 10px; margin-bottom: 8px; background: rgba(255,255,255,0.05); }
    .user-avatar { width: 34px; height: 34px; border-radius: 50%; background: var(--orange); display: flex; align-items: center; justify-content: center; font-family: 'Syne', sans-serif; font-size: 13px; font-weight: 700; color: white; flex-shrink: 0; }
    .user-name { font-size: 13px; font-weight: 600; color: white; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .user-role { font-size: 11px; color: rgba(255,255,255,0.4); }
    .btn-logout { width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px; padding: 9px; border-radius: 10px; background: rgba(239,68,68,0.1); color: #F87171; font-family: 'DM Sans', sans-serif; font-size: 13px; font-weight: 600; border: 1px solid rgba(239,68,68,0.2); cursor: pointer; transition: all 0.2s; }
    .btn-logout:hover { background: rgba(239,68,68,0.2); color: #FCA5A5; }

    /* ‚îÄ‚îÄ Mobile bottom nav ‚îÄ‚îÄ */
    .mobile-nav {
      display: none;
      position: fixed; bottom: 0; left: 0; right: 0;
      background: var(--gray-900);
      padding: 10px 0 calc(10px + env(safe-area-inset-bottom));
      z-index: 50;
      border-top: 1px solid rgba(255,255,255,0.07);
    }
    .mobile-nav-inner { display: flex; justify-content: space-around; }
    .mobile-nav-link {
      display: flex; flex-direction: column; align-items: center; gap: 4px;
      color: rgba(255,255,255,0.45); text-decoration: none;
      font-size: 10px; font-weight: 600; padding: 4px 12px;
      border-radius: 10px; transition: all 0.2s;
    }
    .mobile-nav-link.active { color: var(--orange); }

    /* ‚îÄ‚îÄ Main ‚îÄ‚îÄ */
    .main { flex: 1; overflow-y: auto; padding: 32px 36px; }

    .back-link { display: inline-flex; align-items: center; gap: 6px; font-size: 12px; font-weight: 600; color: var(--gray-400); text-decoration: none; transition: color 0.2s; margin-bottom: 12px; }
    .back-link:hover { color: var(--orange); }

    /* ‚îÄ‚îÄ Barre d'actions desktop ‚îÄ‚îÄ */
    .actions-bar {
      display: flex; align-items: flex-start; justify-content: space-between;
      margin-bottom: 24px; flex-wrap: wrap; gap: 12px;
    }
    .actions-left { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; }
    .actions-right { display: flex; align-items: center; gap: 8px; flex-wrap: wrap; }

    .quote-title { font-family: 'Syne', sans-serif; font-size: 22px; font-weight: 800; color: var(--gray-800); }
    .quote-meta { font-size: 13px; color: var(--gray-400); margin-top: 3px; }

    .badge { display: inline-flex; align-items: center; gap: 5px; padding: 5px 14px; border-radius: 100px; font-size: 12px; font-weight: 700; white-space: nowrap; }
    .badge::before { content: ''; width: 6px; height: 6px; border-radius: 50%; background: currentColor; opacity: 0.6; }
    .badge-draft    { background: var(--gray-100);    color: var(--gray-600); }
    .badge-sent     { background: var(--blue-light);  color: var(--blue); }
    .badge-accepted { background: var(--green-light); color: var(--green); }
    .badge-rejected { background: var(--red-light);   color: var(--red); }
    .badge-expired  { background: var(--yellow-light);color: var(--yellow); }

    .btn-action {
      display: inline-flex; align-items: center; gap: 7px;
      padding: 9px 16px; border-radius: 10px; border: none;
      font-family: 'DM Sans', sans-serif; font-size: 13px; font-weight: 700;
      cursor: pointer; transition: all 0.2s; white-space: nowrap; text-decoration: none;
    }
    .btn-print    { background: var(--gray-100); color: var(--gray-700); border: 1.5px solid var(--gray-200); }
    .btn-print:hover { background: var(--gray-200); }
    .btn-pdf      { background: #FFF1F1; color: #E11D48; }
    .btn-pdf:hover { background: #FFE4E6; }
    .btn-email    { background: var(--blue-light); color: var(--blue); }
    .btn-email:hover { background: #DBEAFE; }
    .btn-whatsapp { background: #F0FDF4; color: var(--whatsapp); }
    .btn-whatsapp:hover { background: #DCFCE7; }
    .btn-status   { background: var(--orange-light); color: var(--orange); }
    .btn-status:hover { background: #FDE9D0; }
    .btn-delete   { background: var(--red-light); color: var(--red); }
    .btn-delete:hover { background: var(--red); color: white; }
    .btn-edit     { background: var(--blue-light); color: var(--blue); }
    .btn-edit:hover { background: #DBEAFE; }

    /* ‚îÄ‚îÄ Mobile action bar ‚îÄ‚îÄ */
    .mobile-actions-bar {
      display: none;
      background: var(--white);
      border-radius: 14px;
      padding: 14px;
      margin-bottom: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.04), 0 4px 16px rgba(0,0,0,0.04);
    }
    .mobile-actions-header {
      display: flex; align-items: center; justify-content: space-between;
      margin-bottom: 12px;
    }
    .mobile-quote-title { font-family: 'Syne', sans-serif; font-size: 17px; font-weight: 800; color: var(--gray-800); }
    .mobile-quote-meta { font-size: 12px; color: var(--gray-400); margin-top: 2px; }
    .mobile-actions-grid {
      display: grid; grid-template-columns: 1fr 1fr; gap: 8px;
    }
    .btn-mobile-action {
      display: flex; align-items: center; justify-content: center; gap: 7px;
      padding: 10px 10px; border-radius: 10px; border: none;
      font-family: 'DM Sans', sans-serif; font-size: 12px; font-weight: 700;
      cursor: pointer; transition: all 0.2s; text-decoration: none;
    }
    .btn-mobile-action.full { grid-column: span 2; }
    .btn-m-edit     { background: var(--blue-light); color: var(--blue); }
    .btn-m-pdf      { background: #FFF1F1; color: #E11D48; }
    .btn-m-email    { background: var(--blue-light); color: var(--blue); }
    .btn-m-whatsapp { background: #F0FDF4; color: var(--whatsapp); }
    .btn-m-status   { background: var(--orange-light); color: var(--orange); }
    .btn-m-print    { background: var(--gray-100); color: var(--gray-600); }
    .btn-m-delete   { background: var(--red-light); color: var(--red); }
    .btn-m-delete:hover { background: var(--red); color: white; }

    /* ‚îÄ‚îÄ Document devis ‚îÄ‚îÄ */
    .quote-doc {
      background: var(--white);
      border-radius: 16px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.04), 0 8px 32px rgba(0,0,0,0.06);
      overflow: hidden;
      animation: slideUp 0.35s ease;
    }
    @keyframes slideUp { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }

    .doc-header {
      padding: 40px 48px 32px;
      display: flex; justify-content: space-between; align-items: flex-start;
      border-bottom: 2px solid var(--gray-100);
      background: linear-gradient(135deg, var(--gray-50) 0%, var(--white) 100%);
    }
    .doc-company-name {
      font-family: 'Syne', sans-serif; font-size: 24px; font-weight: 800;
      color: var(--gray-800); margin-bottom: 6px;
    }
    .doc-company-info { font-size: 13px; color: var(--gray-500); line-height: 1.7; }

    .doc-quote-info { text-align: right; }
    .doc-quote-label {
      font-size: 11px; font-weight: 700; letter-spacing: 0.1em;
      text-transform: uppercase; color: var(--gray-400); margin-bottom: 6px;
    }
    .doc-quote-number {
      font-family: 'Syne', sans-serif; font-size: 26px; font-weight: 800;
      color: var(--orange); margin-bottom: 10px;
    }
    .doc-quote-dates { font-size: 13px; color: var(--gray-500); line-height: 1.7; }
    .doc-quote-dates strong { color: var(--gray-700); }

    .doc-body { padding: 36px 48px; }

    .doc-section-title {
      font-size: 10px; font-weight: 700; letter-spacing: 0.1em;
      text-transform: uppercase; color: var(--gray-400); margin-bottom: 10px;
    }
    .doc-client-box {
      background: var(--gray-50); border-radius: 12px;
      padding: 18px 22px; margin-bottom: 32px;
      border-left: 3px solid var(--orange);
    }
    .doc-client-name { font-family: 'Syne', sans-serif; font-size: 17px; font-weight: 700; color: var(--gray-800); margin-bottom: 4px; }
    .doc-client-info { font-size: 13px; color: var(--gray-500); line-height: 1.8; }

    .doc-table { width: 100%; border-collapse: collapse; margin-bottom: 28px; }
    .doc-table thead tr { background: var(--gray-800); }
    .doc-table thead th {
      padding: 12px 16px; font-size: 11px; font-weight: 700;
      letter-spacing: 0.06em; text-transform: uppercase;
      color: rgba(255,255,255,0.7); text-align: left;
    }
    .doc-table thead th.right { text-align: right; }
    .doc-table tbody tr { border-bottom: 1px solid var(--gray-100); }
    .doc-table tbody td { padding: 14px 16px; font-size: 14px; color: var(--gray-700); }
    .doc-table tbody td.right { text-align: right; font-weight: 600; color: var(--gray-800); }
    .doc-table tbody td.desc { font-weight: 500; color: var(--gray-800); }
    .doc-table tfoot tr { border-top: 2px solid var(--gray-200); }
    .doc-table tfoot td { padding: 10px 16px; font-size: 14px; }
    .doc-table tfoot .label { color: var(--gray-500); text-align: right; }
    .doc-table tfoot .value { text-align: right; font-weight: 700; color: var(--gray-800); }
    .doc-table tfoot .total-row td { padding-top: 14px; }
    .doc-table tfoot .total-label { color: var(--gray-800); font-family: 'Syne', sans-serif; font-size: 16px; font-weight: 800; text-align: right; }
    .doc-table tfoot .total-value { font-family: 'Syne', sans-serif; font-size: 20px; font-weight: 800; color: var(--orange); text-align: right; }

    .doc-notes { background: var(--gray-50); border-radius: 10px; padding: 16px 20px; margin-top: 8px; }
    .doc-notes p { font-size: 13px; color: var(--gray-600); line-height: 1.6; }

    .doc-footer {
      padding: 20px 48px;
      border-top: 2px solid var(--gray-100);
      display: flex; align-items: center; justify-content: space-between;
      background: var(--gray-50);
    }
    .doc-footer-text { font-size: 12px; color: var(--gray-400); }
    .doc-footer-brand { font-family: 'Syne', sans-serif; font-size: 13px; font-weight: 700; color: var(--orange); }

    /* Skeleton */
    .skeleton { background: linear-gradient(90deg, var(--gray-100) 25%, var(--gray-200) 50%, var(--gray-100) 75%); background-size: 200% 100%; animation: shimmer 1.4s infinite; border-radius: 8px; }
    @keyframes shimmer { from { background-position: 200% 0; } to { background-position: -200% 0; } }

    /* Modal */
    .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); z-index: 100; align-items: center; justify-content: center; padding: 20px; }
    .modal-overlay.show { display: flex; }
    .modal { background: var(--white); border-radius: 16px; padding: 28px; max-width: 420px; width: 100%; box-shadow: 0 20px 60px rgba(0,0,0,0.15); animation: slideUp 0.25s ease; }
    .modal-icon { width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 16px; }
    .modal-icon.orange { background: var(--orange-light); color: var(--orange); }
    .modal-icon.red { background: var(--red-light); color: var(--red); }
    .modal h3 { font-family: 'Syne', sans-serif; font-size: 17px; font-weight: 800; color: var(--gray-800); margin-bottom: 8px; }
    .modal p { font-size: 14px; color: var(--gray-500); margin-bottom: 20px; line-height: 1.5; }
    .modal-actions { display: flex; justify-content: flex-end; gap: 10px; }
    .btn-modal-cancel { padding: 9px 18px; border-radius: 10px; border: 1.5px solid var(--gray-200); background: var(--gray-100); color: var(--gray-600); font-family: 'DM Sans', sans-serif; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
    .btn-modal-cancel:hover { background: var(--gray-200); }
    .btn-modal-confirm-red { padding: 9px 18px; border-radius: 10px; border: none; background: var(--red); color: white; font-family: 'DM Sans', sans-serif; font-size: 13px; font-weight: 700; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 6px; }
    .btn-modal-confirm-red:hover { filter: brightness(1.1); }
    .status-options { display: flex; flex-direction: column; gap: 8px; margin-bottom: 20px; }
    .status-option { display: flex; align-items: center; gap: 12px; padding: 12px 14px; border-radius: 10px; border: 1.5px solid var(--gray-200); cursor: pointer; transition: all 0.2s; background: var(--white); width: 100%; font-family: 'DM Sans', sans-serif; font-size: 14px; font-weight: 500; color: var(--gray-700); }
    .status-option:hover { border-color: var(--orange); background: var(--orange-light); }
    .status-option.selected { border-color: var(--orange); background: var(--orange-light); color: var(--orange); font-weight: 700; }

    /* Toast */
    .toast { position: fixed; bottom: 80px; right: 20px; padding: 14px 20px; border-radius: 12px; font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 10px; box-shadow: 0 8px 32px rgba(0,0,0,0.12); animation: toastIn 0.3s ease; z-index: 999; max-width: calc(100vw - 40px); }
    .toast.success { background: var(--green); color: white; }
    .toast.error   { background: var(--red);   color: white; }
    @keyframes toastIn { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }

    @keyframes spin { to { transform: rotate(360deg); } }

    /* ‚îÄ‚îÄ PDF MODE ‚îÄ‚îÄ */
    .pdf-mode .doc-company-name   { color: #000000 !important; }
    .pdf-mode .doc-company-info   { color: #000000 !important; }
    .pdf-mode .doc-quote-label    { color: #000000 !important; }
    .pdf-mode .doc-quote-number   { color: #EA6C0A !important; }
    .pdf-mode .doc-quote-dates    { color: #000000 !important; }
    .pdf-mode .doc-quote-dates strong { color: #000000 !important; }
    .pdf-mode .doc-section-title  { color: #000000 !important; }
    .pdf-mode .doc-client-box     { background: #DDDDDD !important; border-left-color: #EA6C0A !important; }
    .pdf-mode .doc-client-name    { color: #000000 !important; }
    .pdf-mode .doc-client-info    { color: #000000 !important; }
    .pdf-mode .doc-table thead tr { background: #000000 !important; }
    .pdf-mode .doc-table thead th { color: #FFFFFF !important; }
    .pdf-mode .doc-table tbody td { color: #000000 !important; }
    .pdf-mode .doc-table tbody td.desc  { color: #000000 !important; font-weight: 600 !important; }
    .pdf-mode .doc-table tbody td.right { color: #000000 !important; }
    .pdf-mode .doc-table tbody tr { border-bottom: 1px solid #000000 !important; }
    .pdf-mode .doc-table tfoot .label { color: #000000 !important; }
    .pdf-mode .doc-table tfoot .value { color: #000000 !important; }
    .pdf-mode .doc-table tfoot .total-label { color: #000000 !important; }
    .pdf-mode .doc-table tfoot .total-value { color: #EA6C0A !important; }
    .pdf-mode .doc-notes   { background: #DDDDDD !important; }
    .pdf-mode .doc-notes p { color: #000000 !important; }
    .pdf-mode .doc-header  { background: #FFFFFF !important; border-bottom: 2px solid #000000 !important; }
    .pdf-mode .doc-footer  { background: #DDDDDD !important; border-top: 2px solid #000000 !important; }
    .pdf-mode .doc-footer-text  { color: #000000 !important; }
    .pdf-mode .doc-footer-brand { color: #EA6C0A !important; }

    /* ‚îÄ‚îÄ PRINT ‚îÄ‚îÄ */
    @media print {
      body { background: white; display: block; }
      .sidebar, .back-link, .actions-bar, .mobile-actions-bar, .mobile-nav, .modal-overlay, .toast { display: none !important; }
      .main { padding: 0; }
      .quote-doc { box-shadow: none; border-radius: 0; }
      .doc-header { padding: 32px; }
      .doc-body { padding: 28px 32px; }
      .doc-footer { padding: 16px 32px; }
      .doc-table tbody tr:hover { background: none; }
    }

    /* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
    @media (max-width: 900px) {
      .sidebar { display: none; }
      .mobile-nav { display: block; }
      .main { padding: 16px 12px 100px; }

      /* Hide desktop actions bar, show mobile one */
      .actions-bar { display: none; }
      .mobile-actions-bar { display: block; }

      /* Compact doc for mobile */
      .doc-header {
        flex-direction: column; gap: 16px;
        padding: 20px 18px 16px;
      }
      .doc-quote-info { text-align: left; }
      .doc-company-name { font-size: 18px; }
      .doc-quote-number { font-size: 20px; }
      .doc-body { padding: 18px; }
      .doc-footer { padding: 14px 18px; flex-direction: column; gap: 4px; align-items: flex-start; }

      /* Scrollable table on mobile */
      .doc-table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; margin: 0 -18px; padding: 0 18px; }
      .doc-table { min-width: 500px; }

      .back-link { margin-bottom: 6px; }
      .toast { bottom: 90px; }
    }
    @media (min-width: 901px) {
      .toast { bottom: 28px; right: 28px; }
    }
  </style>
</head>

<body>

  <!-- Sidebar desktop -->
  <aside class="sidebar">
    <div class="sidebar-logo">
      <div class="sidebar-logo-icon">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
      </div>
      <span>Devis App</span>
    </div>
    <nav class="sidebar-nav">
      <span class="nav-section-label">Menu</span>
      <a href="dashboard.html" class="nav-link">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
        Dashboard
      </a>
      <a href="quotes.html" class="nav-link active">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
        Devis
      </a>
      <a href="liste-clients.html" class="nav-link">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>
        Clients
      </a>
      <span class="nav-section-label" style="margin-top:8px;">Compte</span>
      <a href="settings.html" class="nav-link">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
        Param√®tres
      </a>
    </nav>
    <div class="sidebar-footer">
      <div class="user-card">
        <div class="user-avatar" id="userAvatar">?</div>
        <div>
          <div class="user-name" id="sidebarName">Chargement...</div>
          <div class="user-role" id="sidebarCompany">‚Äî</div>
        </div>
      </div>
      <button class="btn-logout" id="logoutBtn">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
        D√©connexion
      </button>
    </div>
  </aside>

  <!-- Main -->
  <main class="main">

    <a href="quotes.html" class="back-link">
      <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="15 18 9 12 15 6"/></svg>
      Retour aux devis
    </a>

    <!-- ‚îÄ‚îÄ Desktop actions bar ‚îÄ‚îÄ -->
    <div class="actions-bar">
      <div class="actions-left">
        <div>
          <div class="quote-title" id="pageQuoteNumber">Devis ‚Äî</div>
          <div class="quote-meta" id="pageQuoteMeta">Chargement...</div>
        </div>
        <span id="pageBadge"></span>
      </div>
      <div class="actions-right">
        <button class="btn-action btn-edit" id="btnEdit">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
          Modifier
        </button>
        <button class="btn-action btn-print" id="btnPrint">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
          Imprimer
        </button>
        <button class="btn-action btn-pdf" id="btnPdf">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
          T√©l√©charger PDF
        </button>
        <button class="btn-action btn-email" id="btnEmail">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
          Email
        </button>
        <button class="btn-action btn-whatsapp" id="btnWhatsapp">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 01-.9 3.8 8.5 8.5 0 01-7.6 4.7 8.38 8.38 0 01-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 01-.9-3.8 8.5 8.5 0 014.7-7.6 8.38 8.38 0 013.8-.9h.5a8.48 8.48 0 018 8v.5z"/></svg>
          WhatsApp
        </button>
        <button class="btn-action btn-status" id="btnStatus">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
          Statut
        </button>
        <button class="btn-action btn-delete" id="btnDelete">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 01-2 2H8a2 2 0 01-2-2L5 6"/></svg>
          Supprimer
        </button>
      </div>
    </div>

    <!-- ‚îÄ‚îÄ Mobile actions card ‚îÄ‚îÄ -->
    <div class="mobile-actions-bar">
      <div class="mobile-actions-header">
        <div>
          <div class="mobile-quote-title" id="mobileQuoteNumber">Devis ‚Äî</div>
          <div class="mobile-quote-meta" id="mobileQuoteMeta">Chargement...</div>
        </div>
        <span id="mobileBadge"></span>
      </div>
      <div class="mobile-actions-grid">
        <button class="btn-mobile-action btn-m-edit" id="btnEditM">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 013 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>
          Modifier
        </button>
        <button class="btn-mobile-action btn-m-status" id="btnStatusM">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
          Statut
        </button>
        <button class="btn-mobile-action btn-m-pdf" id="btnPdfM">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
          PDF
        </button>
        <button class="btn-mobile-action btn-m-print" id="btnPrintM">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 01-2-2v-5a2 2 0 012-2h16a2 2 0 012 2v5a2 2 0 01-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>
          Imprimer
        </button>
        <button class="btn-mobile-action btn-m-email" id="btnEmailM">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
          Email
        </button>
        <button class="btn-mobile-action btn-m-whatsapp" id="btnWhatsappM">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 01-.9 3.8 8.5 8.5 0 01-7.6 4.7 8.38 8.38 0 01-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 01-.9-3.8 8.5 8.5 0 014.7-7.6 8.38 8.38 0 013.8-.9h.5a8.48 8.48 0 018 8v.5z"/></svg>
          WhatsApp
        </button>
        <button class="btn-mobile-action btn-m-delete full" id="btnDeleteM">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 01-2 2H8a2 2 0 01-2-2L5 6"/></svg>
          Supprimer ce devis
        </button>
      </div>
    </div>

    <!-- Document -->
    <div class="quote-doc" id="quoteDoc">
      <div class="doc-header">
        <div>
          <div class="doc-company-name" id="docCompanyName">‚Äî</div>
          <div class="doc-company-info" id="docCompanyInfo">‚Äî</div>
        </div>
        <div class="doc-quote-info">
          <div class="doc-quote-label">Devis</div>
          <div class="doc-quote-number" id="docQuoteNumber">‚Äî</div>
          <div class="doc-quote-dates" id="docQuoteDates">‚Äî</div>
        </div>
      </div>

      <div class="doc-body">
        <div class="doc-section-title">Adress√© √†</div>
        <div class="doc-client-box">
          <div class="doc-client-name" id="docClientName">‚Äî</div>
          <div class="doc-client-info" id="docClientInfo">‚Äî</div>
        </div>

        <div class="doc-table-wrap">
          <table class="doc-table">
            <thead>
              <tr>
                <th style="width:46%">Description</th>
                <th class="right" style="width:14%">Qt√©</th>
                <th class="right" style="width:20%">Prix unit.</th>
                <th class="right" style="width:20%">Total HT</th>
              </tr>
            </thead>
            <tbody id="docItems">
              <tr><td colspan="4"><div class="skeleton" style="height:40px;width:100%;"></div></td></tr>
            </tbody>
            <tfoot id="docTotals"></tfoot>
          </table>
        </div>

        <div id="docNotesWrap" style="display:none; margin-top: 24px;">
          <div class="doc-section-title">Notes et conditions</div>
          <div class="doc-notes"><p id="docNotes"></p></div>
        </div>
      </div>

      <div class="doc-footer">
        <div class="doc-footer-text">Merci de votre confiance.</div>
        <div class="doc-footer-brand" id="docFooterBrand">Devis App</div>
      </div>
    </div>

  </main>

  <!-- Mobile bottom nav -->
  <nav class="mobile-nav">
    <div class="mobile-nav-inner">
      <a href="dashboard.html" class="mobile-nav-link">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
        Dashboard
      </a>
      <a href="quotes.html" class="mobile-nav-link active">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
        Devis
      </a>
      <a href="liste-clients.html" class="mobile-nav-link">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>
        Clients
      </a>
      <a href="settings.html" class="mobile-nav-link">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
        R√©glages
      </a>
    </div>
  </nav>

  <!-- Modal statut -->
  <div class="modal-overlay" id="statusModal">
    <div class="modal">
      <div class="modal-icon orange">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
      </div>
      <h3>Changer le statut</h3>
      <p>S√©lectionnez le nouveau statut pour ce devis.</p>
      <div class="status-options">
        <button class="status-option" data-status="draft">üìù Brouillon</button>
        <button class="status-option" data-status="sent">üì§ Envoy√©</button>
        <button class="status-option" data-status="accepted">‚úÖ Accept√©</button>
        <button class="status-option" data-status="rejected">‚ùå Refus√©</button>
        <button class="status-option" data-status="expired">‚è∞ Expir√©</button>
      </div>
      <div class="modal-actions">
        <button class="btn-modal-cancel" id="cancelStatus">Annuler</button>
      </div>
    </div>
  </div>

  <!-- Modal suppression -->
  <div class="modal-overlay" id="deleteModal">
    <div class="modal">
      <div class="modal-icon red">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 01-2 2H8a2 2 0 01-2-2L5 6"/></svg>
      </div>
      <h3>Supprimer ce devis ?</h3>
      <p>Cette action est irr√©versible. Le devis et toutes ses lignes seront supprim√©s d√©finitivement.</p>
      <div class="modal-actions">
        <button class="btn-modal-cancel" id="cancelDelete">Annuler</button>
        <button class="btn-modal-confirm-red" id="confirmDelete">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 01-2 2H8a2 2 0 01-2-2L5 6"/></svg>
          Supprimer
        </button>
      </div>
    </div>
  </div>

<script type="module">
import { createClient } from 'https://esm.sh/@supabase/supabase-js'

const supabase = createClient(
  'https://xeezdzbotsblzclnmnxg.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhlZXpkemJvdHNibHpjbG5tbnhnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0NDk3NTQsImV4cCI6MjA4NjAyNTc1NH0.RHIGavm6M9WCR6nve1Iz_JKFeQRlpRCU2FNAr9E02PM'
)

const fmt     = (n) => new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'XOF' }).format(n || 0)
const fmtDate = (d) => d ? new Date(d).toLocaleDateString('fr-FR', { day: '2-digit', month: 'long', year: 'numeric' }) : '‚Äî'

const quoteId = new URLSearchParams(window.location.search).get('id')
let quoteData = null

// ‚îÄ‚îÄ Toast ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function showToast(msg, type = 'success') {
  document.querySelector('.toast')?.remove()
  const t = document.createElement('div')
  t.className = `toast ${type}`
  t.innerHTML = type === 'success'
    ? `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg> ${msg}`
    : `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg> ${msg}`
  document.body.appendChild(t)
  setTimeout(() => t.remove(), 3500)
}

// ‚îÄ‚îÄ Init ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function init() {
  if (!quoteId) { window.location.href = 'quotes.html'; return }
  const { data: { session } } = await supabase.auth.getSession()
  if (!session) { window.location.href = 'login.html'; return }
  await loadUserProfile(session.user.id)
  await loadQuote()
}

async function loadUserProfile(userId) {
  const { data } = await supabase.from('profiles')
    .select('first_name, last_name, company, address, city, country, phone')
    .eq('id', userId).single()
  if (data) {
    const initials = [data.first_name?.[0], data.last_name?.[0]].filter(Boolean).join('').toUpperCase() || 'U'
    document.getElementById('userAvatar').textContent = initials
    document.getElementById('sidebarName').textContent = [data.first_name, data.last_name].filter(Boolean).join(' ') || 'Utilisateur'
    document.getElementById('sidebarCompany').textContent = data.company || 'Mon entreprise'
    document.getElementById('docCompanyName').textContent = data.company || [data.first_name, data.last_name].filter(Boolean).join(' ')
    document.getElementById('docFooterBrand').textContent = data.company || 'Devis App'
    const info = [data.address, data.city, data.country, data.phone].filter(Boolean).join('\n')
    document.getElementById('docCompanyInfo').innerHTML = info.replace(/\n/g, '<br>')
  }
}

async function loadQuote() {
  const { data, error } = await supabase
    .from('quotes')
    .select(`*, clients(id, full_name, email, phone, address, city, postal_code, country, company_name), quote_items(*)`)
    .eq('id', quoteId).single()
  if (error || !data) {
    showToast('Devis introuvable.', 'error')
    setTimeout(() => window.location.href = 'quotes.html', 2000)
    return
  }
  quoteData = data
  renderQuote(data)
}

function statusBadge(status) {
  const map = {
    draft:    ['badge-draft',    'Brouillon'],
    sent:     ['badge-sent',     'Envoy√©'],
    accepted: ['badge-accepted', 'Accept√©'],
    rejected: ['badge-rejected', 'Refus√©'],
    expired:  ['badge-expired',  'Expir√©'],
  }
  const [cls, label] = map[status] || map.draft
  return `<span class="badge ${cls}">${label}</span>`
}

function renderQuote(q) {
  const client = q.clients || {}
  const items  = q.quote_items || []

  const title = `Devis N¬∞${q.quote_number || '‚Äî'}`
  const meta = `${client.full_name || '‚Äî'} ¬∑ ${fmtDate(q.created_at)}`
  const badge = statusBadge(q.status)

  // Desktop
  document.getElementById('pageQuoteNumber').textContent = title
  document.getElementById('pageQuoteMeta').textContent = meta
  document.getElementById('pageBadge').innerHTML = badge

  // Mobile
  document.getElementById('mobileQuoteNumber').textContent = title
  document.getElementById('mobileQuoteMeta').textContent = meta
  document.getElementById('mobileBadge').innerHTML = badge

  // Document header
  document.getElementById('docQuoteNumber').textContent = q.quote_number || '‚Äî'
  document.getElementById('docQuoteDates').innerHTML = `<strong>Date :</strong> ${fmtDate(q.created_at)}`

  // Client
  document.getElementById('docClientName').textContent = client.full_name || '‚Äî'
  const clientInfo = [
    client.company_name, client.address,
    [client.postal_code, client.city].filter(Boolean).join(' '),
    client.country, client.email, client.phone
  ].filter(Boolean).join('\n')
  document.getElementById('docClientInfo').innerHTML = clientInfo.replace(/\n/g, '<br>') || '‚Äî'

  // Items
  const tbody = document.getElementById('docItems')
  tbody.innerHTML = items.length
    ? items.map(item => `
        <tr>
          <td class="desc">${item.description || '‚Äî'}</td>
          <td class="right">${item.quantity}</td>
          <td class="right">${fmt(item.unit_price)}</td>
          <td class="right">${fmt(item.total)}</td>
        </tr>`).join('')
    : `<tr><td colspan="4" style="text-align:center;color:var(--gray-400);padding:20px;">Aucune ligne</td></tr>`

  // Totals
  document.getElementById('docTotals').innerHTML = `
    <tr><td colspan="2"></td><td class="label">Sous-total HT</td><td class="value">${fmt(q.subtotal)}</td></tr>
    <tr><td colspan="2"></td><td class="label">TVA (${q.tax_rate || 0}%)</td><td class="value">${fmt(q.tax_amount)}</td></tr>
    <tr class="total-row"><td colspan="2"></td><td class="total-label">Total TTC</td><td class="total-value">${fmt(q.total_amount)}</td></tr>`

  if (q.notes) {
    document.getElementById('docNotesWrap').style.display = 'block'
    document.getElementById('docNotes').textContent = q.notes
  }
}

// ‚îÄ‚îÄ Generate PDF ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function generatePdf(returnBlob) {
  const { jsPDF } = window.jspdf
  const elem       = document.getElementById('quoteDoc')
  const actionsBar = document.querySelector('.actions-bar')
  const mobileBar  = document.querySelector('.mobile-actions-bar')
  const backLink   = document.querySelector('.back-link')
  const filename   = 'Devis-' + (quoteData ? quoteData.quote_number : 'devis') + '.pdf'

  actionsBar.style.visibility = 'hidden'
  mobileBar.style.visibility  = 'hidden'
  backLink.style.visibility   = 'hidden'
  elem.classList.add('pdf-mode')

  try {
    await document.fonts.ready
    await new Promise(r => setTimeout(r, 300))
    const canvas = await html2canvas(elem, {
      scale: 2, useCORS: true, allowTaint: false,
      backgroundColor: '#ffffff', logging: false,
      imageTimeout: 0, removeContainer: true, letterRendering: true,
      windowWidth: elem.scrollWidth, windowHeight: elem.scrollHeight
    })
    const imgData = canvas.toDataURL('image/jpeg', 0.7)
    const pdf = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4', compress: true })
    const pageW = pdf.internal.pageSize.getWidth()
    const pageH = pdf.internal.pageSize.getHeight()
    const imgH = (canvas.height / canvas.width) * pageW
    let yOff = 0, leftH = imgH
    while (leftH > 0) {
      pdf.addImage(imgData, 'JPEG', 0, yOff, pageW, imgH, '', 'FAST')
      leftH -= pageH; yOff -= pageH
      if (leftH > 0) pdf.addPage()
    }
    if (returnBlob) return pdf.output('blob')
    pdf.save(filename)
  } finally {
    elem.classList.remove('pdf-mode')
    actionsBar.style.visibility = 'visible'
    mobileBar.style.visibility  = 'visible'
    backLink.style.visibility   = 'visible'
  }
}

async function handlePdf(btn) {
  if (!quoteData) return
  const origHtml = btn.innerHTML
  btn.disabled = true
  btn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation:spin 0.7s linear infinite;display:inline-block"><path d="M21 12a9 9 0 11-6.219-8.56"/></svg> G√©n√©ration...'
  showToast('G√©n√©ration du PDF en cours...', 'success')
  try { await generatePdf(false); showToast('PDF t√©l√©charg√© !') }
  catch(e) { showToast('Erreur g√©n√©ration PDF.', 'error') }
  btn.disabled = false; btn.innerHTML = origHtml
}

async function sharePdfWithMessage(button, isEmail = false) {
  if (!quoteData) return
  const origHtml = button.innerHTML
  const filename = 'Devis-' + (quoteData.quote_number || 'devis') + '.pdf'
  const clientName = quoteData.clients?.full_name || ''
  const messageText = `Bonjour ${clientName} üëã,\n\nVeuillez trouver ci-joint votre devis N¬∞${quoteData.quote_number} d'un montant de ${fmt(quoteData.total_amount)} TTC üìÑ.\n\nN'h√©sitez pas √† me contacter pour toute question üòä.\n\nCordialement`

  button.disabled = true
  button.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation:spin 0.7s linear infinite;display:inline-block"><path d="M21 12a9 9 0 11-6.219-8.56"/></svg>'

  let pdfBlob = null
  try { pdfBlob = await generatePdf(true) }
  catch(e) { showToast('Erreur g√©n√©ration PDF.', 'error'); button.disabled = false; button.innerHTML = origHtml; return }

  const pdfFile = new File([pdfBlob], filename, { type: 'application/pdf' })

  if (navigator.canShare && navigator.canShare({ files: [pdfFile] })) {
    try {
      await navigator.share({ title: `Devis N¬∞${quoteData.quote_number}`, text: messageText, files: [pdfFile] })
      updateStatus('sent', false)
      showToast('Devis partag√© avec succ√®s !')
    } catch(err) { if (err.name !== 'AbortError') showToast('Partage annul√©.', 'error') }
  } else {
    const url = URL.createObjectURL(pdfBlob)
    const a = document.createElement('a'); a.href = url; a.download = filename; a.click()
    setTimeout(() => URL.revokeObjectURL(url), 1000)
    if (isEmail) {
      const email = quoteData.clients?.email
      if (email) {
        window.open(`mailto:${email}?subject=${encodeURIComponent(`Devis N¬∞${quoteData.quote_number}`)}&body=${encodeURIComponent(messageText)}`)
        showToast('üìÑ PDF t√©l√©charg√© ‚Äî joignez-le dans l\'email.')
      } else { showToast('Aucun email enregistr√© pour ce client.', 'error') }
    } else {
      const cleanPhone = (quoteData.clients?.phone || '').replace(/[\s\-\(\)]/g, '').replace(/^\+/, '')
      if (cleanPhone) {
        window.open(`https://wa.me/${cleanPhone}?text=${encodeURIComponent(messageText)}`)
        showToast('üìÑ PDF t√©l√©charg√© ‚Äî joignez-le dans WhatsApp.')
      } else { showToast('Aucun num√©ro WhatsApp enregistr√© pour ce client.', 'error') }
    }
    updateStatus('sent', false)
  }
  button.disabled = false; button.innerHTML = origHtml
}

async function updateStatus(status, showFeedback = true) {
  const { error } = await supabase.from('quotes').update({ status }).eq('id', quoteId)
  if (error) { showToast('Erreur mise √† jour statut', 'error'); return }
  if (quoteData) quoteData.status = status
  const badge = statusBadge(status)
  document.getElementById('pageBadge').innerHTML = badge
  document.getElementById('mobileBadge').innerHTML = badge
  if (showFeedback) showToast('Statut mis √† jour !')
}

function openStatusModal() {
  document.querySelectorAll('.status-option').forEach(opt => {
    opt.classList.toggle('selected', opt.dataset.status === (quoteData ? quoteData.status : ''))
  })
  document.getElementById('statusModal').classList.add('show')
}

// ‚îÄ‚îÄ Button events ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Desktop
document.getElementById('btnEdit').addEventListener('click', () => window.location.href = `edit-quote.html?id=${quoteId}`)
document.getElementById('btnPrint').addEventListener('click', () => window.print())
document.getElementById('btnPdf').addEventListener('click', function() { handlePdf(this) })
document.getElementById('btnEmail').addEventListener('click', function() { sharePdfWithMessage(this, true) })
document.getElementById('btnWhatsapp').addEventListener('click', function() { sharePdfWithMessage(this, false) })
document.getElementById('btnStatus').addEventListener('click', openStatusModal)
document.getElementById('btnDelete').addEventListener('click', () => document.getElementById('deleteModal').classList.add('show'))

// Mobile
document.getElementById('btnEditM').addEventListener('click', () => window.location.href = `edit-quote.html?id=${quoteId}`)
document.getElementById('btnPrintM').addEventListener('click', () => window.print())
document.getElementById('btnPdfM').addEventListener('click', function() { handlePdf(this) })
document.getElementById('btnEmailM').addEventListener('click', function() { sharePdfWithMessage(this, true) })
document.getElementById('btnWhatsappM').addEventListener('click', function() { sharePdfWithMessage(this, false) })
document.getElementById('btnStatusM').addEventListener('click', openStatusModal)
document.getElementById('btnDeleteM').addEventListener('click', () => document.getElementById('deleteModal').classList.add('show'))

// Status options
document.querySelectorAll('.status-option').forEach(opt => {
  opt.addEventListener('click', () => {
    document.getElementById('statusModal').classList.remove('show')
    updateStatus(opt.dataset.status)
  })
})
document.getElementById('cancelStatus').addEventListener('click', () => document.getElementById('statusModal').classList.remove('show'))

// Delete modal
document.getElementById('cancelDelete').addEventListener('click', () => document.getElementById('deleteModal').classList.remove('show'))
document.getElementById('confirmDelete').addEventListener('click', async () => {
  document.getElementById('deleteModal').classList.remove('show')
  const { error } = await supabase.from('quotes').delete().eq('id', quoteId)
  if (error) { showToast('Erreur suppression', 'error'); return }
  showToast('Devis supprim√©.')
  setTimeout(() => window.location.href = 'quotes.html', 1200)
})

// Close modals on backdrop click
document.querySelectorAll('.modal-overlay').forEach(overlay => {
  overlay.addEventListener('click', (e) => { if (e.target === e.currentTarget) e.currentTarget.classList.remove('show') })
})

document.getElementById('logoutBtn').addEventListener('click', async () => {
  await supabase.auth.signOut(); window.location.href = 'login.html'
})

init()
</script>

</body>
</html>