<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
  <title>Devis - Devis App</title>
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --orange: #F97316;
      --orange-dark: #EA6C0A;
      --orange-light: #FEF3E7;
      --gray-50: #F9FAFB;
      --gray-100: #F3F4F6;
      --gray-200: #E5E7EB;
      --gray-300: #D1D5DB;
      --gray-400: #9CA3AF;
      --gray-500: #6B7280;
      --gray-600: #4B5563;
      --gray-700: #374151;
      --gray-800: #1F2937;
      --gray-900: #111827;
      --green: #10B981;
      --green-light: #D1FAE5;
      --blue: #3B82F6;
      --blue-light: #EFF6FF;
      --red: #EF4444;
      --red-light: #FFF1F1;
      --yellow: #F59E0B;
      --yellow-light: #FFFBEB;
      --white: #FFFFFF;
      --whatsapp: #25D366;
    }

    body { font-family: 'DM Sans', sans-serif; background: var(--gray-100); min-height: 100vh; display: flex; }

    /* â”€â”€ Sidebar â”€â”€ */
    .sidebar { width: 260px; min-width: 260px; background: var(--gray-900); display: flex; flex-direction: column; height: 100vh; position: sticky; top: 0; }
    .sidebar-logo { padding: 24px 20px; border-bottom: 1px solid rgba(255,255,255,0.07); display: flex; align-items: center; gap: 10px; }
    .sidebar-logo-icon { width: 36px; height: 36px; background: var(--orange); border-radius: 10px; display: flex; align-items: center; justify-content: center; }
    .sidebar-logo span { font-family: 'Syne', sans-serif; font-size: 18px; font-weight: 800; color: white; }
    .sidebar-nav { flex: 1; padding: 16px 12px; display: flex; flex-direction: column; gap: 4px; }
    .nav-section-label { font-size: 10px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; color: rgba(255,255,255,0.3); padding: 12px 12px 6px; }
    .nav-link { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius: 10px; color: rgba(255,255,255,0.55); text-decoration: none; font-size: 14px; font-weight: 500; transition: all 0.2s; }
    .nav-link:hover { background: rgba(255,255,255,0.07); color: rgba(255,255,255,0.9); }
    .nav-link.active { background: rgba(249,115,22,0.15); color: var(--orange); }
    .sidebar-footer { padding: 16px 12px; border-top: 1px solid rgba(255,255,255,0.07); }
    .user-card { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius: 10px; margin-bottom: 8px; background: rgba(255,255,255,0.05); }
    .user-avatar { width: 34px; height: 34px; border-radius: 50%; background: var(--orange); display: flex; align-items: center; justify-content: center; font-family: 'Syne', sans-serif; font-size: 13px; font-weight: 700; color: white; flex-shrink: 0; }
    .user-name { font-size: 13px; font-weight: 600; color: white; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .user-role { font-size: 11px; color: rgba(255,255,255,0.4); }
    .btn-logout { width: 100%; display: flex; align-items: center; justify-content: center; gap: 8px; padding: 9px; border-radius: 10px; background: rgba(239,68,68,0.1); color: #F87171; font-family: 'DM Sans', sans-serif; font-size: 13px; font-weight: 600; border: 1px solid rgba(239,68,68,0.2); cursor: pointer; transition: all 0.2s; }
    .btn-logout:hover { background: rgba(239,68,68,0.2); color: #FCA5A5; }

    /* â”€â”€ Main â”€â”€ */
    .main { flex: 1; overflow-y: auto; padding: 32px 36px; }

    .page-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 28px; }
    .page-title { font-family: 'Syne', sans-serif; font-size: 26px; font-weight: 800; color: var(--gray-800); }
    .page-subtitle { font-size: 14px; color: var(--gray-400); margin-top: 4px; }

    .btn-new {
      display: inline-flex; align-items: center; gap: 8px;
      background: var(--orange); color: white;
      font-family: 'DM Sans', sans-serif; font-size: 14px; font-weight: 700;
      padding: 11px 22px; border-radius: 10px; border: none;
      text-decoration: none; cursor: pointer;
      box-shadow: 0 4px 12px rgba(249,115,22,0.3); transition: all 0.2s;
    }
    .btn-new:hover { background: var(--orange-dark); transform: translateY(-1px); }

    /* â”€â”€ Filtres â”€â”€ */
    .filters-bar {
      display: flex; align-items: center; gap: 12px;
      margin-bottom: 20px; flex-wrap: wrap;
    }
    .search-wrap { position: relative; flex: 1; min-width: 200px; }
    .search-wrap svg { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); color: var(--gray-400); pointer-events: none; }
    .search-input { width: 100%; border: 1.5px solid var(--gray-200); border-radius: 10px; padding: 9px 14px 9px 36px; font-family: 'DM Sans', sans-serif; font-size: 13px; color: var(--gray-800); background: var(--white); outline: none; transition: all 0.2s; }
    .search-input:focus { border-color: var(--orange); box-shadow: 0 0 0 3px rgba(249,115,22,0.1); }

    .filter-btn { padding: 8px 16px; border-radius: 100px; border: 1.5px solid var(--gray-200); background: var(--white); color: var(--gray-600); font-family: 'DM Sans', sans-serif; font-size: 12px; font-weight: 600; cursor: pointer; transition: all 0.2s; white-space: nowrap; }
    .filter-btn:hover { border-color: var(--orange); color: var(--orange); }
    .filter-btn.active { background: var(--orange); color: white; border-color: var(--orange); }

    /* â”€â”€ Card table â”€â”€ */
    .card { background: var(--white); border-radius: 16px; box-shadow: 0 1px 3px rgba(0,0,0,0.04), 0 4px 16px rgba(0,0,0,0.04); overflow: hidden; animation: slideUp 0.35s ease; }
    @keyframes slideUp { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }

    .table-wrap { overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; }
    thead tr { border-bottom: 2px solid var(--gray-100); }
    thead th { font-size: 11px; font-weight: 700; color: var(--gray-500); letter-spacing: 0.06em; text-transform: uppercase; padding: 14px 16px; text-align: left; background: var(--gray-50); }
    tbody tr { border-bottom: 1px solid var(--gray-100); transition: background 0.15s; }
    tbody tr:last-child { border-bottom: none; }
    tbody tr:hover { background: var(--gray-50); }
    tbody td { padding: 14px 16px; font-size: 14px; color: var(--gray-700); vertical-align: middle; }

    /* Badges statut */
    .badge { display: inline-flex; align-items: center; gap: 5px; padding: 4px 12px; border-radius: 100px; font-size: 11px; font-weight: 700; letter-spacing: 0.03em; }
    .badge::before { content: ''; width: 6px; height: 6px; border-radius: 50%; background: currentColor; opacity: 0.6; }
    .badge-draft    { background: var(--gray-100);   color: var(--gray-600); }
    .badge-sent     { background: var(--blue-light);  color: var(--blue); }
    .badge-accepted { background: var(--green-light); color: var(--green); }
    .badge-rejected { background: var(--red-light);   color: var(--red); }
    .badge-expired  { background: var(--yellow-light);color: var(--yellow); }

    .quote-number { font-family: 'Syne', sans-serif; font-size: 13px; font-weight: 700; color: var(--orange); }
    .total-amount { font-family: 'Syne', sans-serif; font-size: 15px; font-weight: 800; color: var(--gray-800); }

    /* Boutons actions */
    .actions-cell { display: flex; align-items: center; gap: 6px; }

    .btn-action {
      display: inline-flex; align-items: center; justify-content: center; gap: 6px;
      padding: 7px 12px; border-radius: 8px; border: none;
      font-family: 'DM Sans', sans-serif; font-size: 12px; font-weight: 600;
      cursor: pointer; transition: all 0.2s; white-space: nowrap;
      text-decoration: none;
    }
    .btn-view   { background: var(--gray-100); color: var(--gray-700); }
    .btn-view:hover { background: var(--gray-200); }

    .btn-email  { background: var(--blue-light); color: var(--blue); }
    .btn-email:hover { background: #DBEAFE; }

    .btn-whatsapp { background: #F0FDF4; color: var(--whatsapp); }
    .btn-whatsapp:hover { background: #DCFCE7; }

    .btn-status { background: var(--orange-light); color: var(--orange); }
    .btn-status:hover { background: #FDE9D0; }

    .btn-delete-sm { background: var(--red-light); color: var(--red); width: 32px; height: 32px; padding: 0; border-radius: 8px; }
    .btn-delete-sm:hover { background: var(--red); color: white; }

    /* Empty state */
    .empty-state { text-align: center; padding: 64px 20px; }
    .empty-icon { width: 64px; height: 64px; background: var(--orange-light); border-radius: 50%; display: flex; align-items: center; justify-content: center; margin: 0 auto 16px; color: var(--orange); }
    .empty-state h3 { font-family: 'Syne', sans-serif; font-size: 17px; font-weight: 700; color: var(--gray-700); margin-bottom: 6px; }
    .empty-state p { font-size: 13px; color: var(--gray-400); margin-bottom: 20px; }

    /* Modal */
    .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.4); backdrop-filter: blur(4px); z-index: 100; align-items: center; justify-content: center; }
    .modal-overlay.show { display: flex; }
    .modal { background: var(--white); border-radius: 16px; padding: 28px; max-width: 420px; width: 90%; box-shadow: 0 20px 60px rgba(0,0,0,0.15); animation: slideUp 0.25s ease; }
    .modal-icon { width: 48px; height: 48px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-bottom: 16px; }
    .modal-icon.red { background: var(--red-light); color: var(--red); }
    .modal-icon.orange { background: var(--orange-light); color: var(--orange); }
    .modal h3 { font-family: 'Syne', sans-serif; font-size: 17px; font-weight: 800; color: var(--gray-800); margin-bottom: 8px; }
    .modal p { font-size: 14px; color: var(--gray-500); margin-bottom: 20px; line-height: 1.5; }
    .modal-actions { display: flex; justify-content: flex-end; gap: 10px; }
    .btn-modal-cancel { padding: 9px 18px; border-radius: 10px; border: 1.5px solid var(--gray-200); background: var(--gray-100); color: var(--gray-600); font-family: 'DM Sans', sans-serif; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
    .btn-modal-cancel:hover { background: var(--gray-200); }
    .btn-modal-confirm-red { padding: 9px 18px; border-radius: 10px; border: none; background: var(--red); color: white; font-family: 'DM Sans', sans-serif; font-size: 13px; font-weight: 700; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 6px; }
    .btn-modal-confirm-red:hover { filter: brightness(1.1); }

    /* Modal statut */
    .status-options { display: flex; flex-direction: column; gap: 8px; margin-bottom: 20px; }
    .status-option { display: flex; align-items: center; gap: 12px; padding: 12px 14px; border-radius: 10px; border: 1.5px solid var(--gray-200); cursor: pointer; transition: all 0.2s; background: var(--white); width: 100%; font-family: 'DM Sans', sans-serif; font-size: 14px; font-weight: 500; color: var(--gray-700); }
    .status-option:hover { border-color: var(--orange); background: var(--orange-light); }
    .status-option.selected { border-color: var(--orange); background: var(--orange-light); color: var(--orange); font-weight: 700; }

    /* Toast */
    .toast { position: fixed; bottom: 28px; right: 28px; padding: 14px 20px; border-radius: 12px; font-size: 14px; font-weight: 600; display: flex; align-items: center; gap: 10px; box-shadow: 0 8px 32px rgba(0,0,0,0.12); animation: toastIn 0.3s ease; z-index: 999; }
    .toast.success { background: var(--green); color: white; }
    .toast.error   { background: var(--red);   color: white; }
    @keyframes toastIn { from { opacity: 0; transform: translateY(12px); } to { opacity: 1; transform: translateY(0); } }

    /* Skeleton */
    .skeleton { background: linear-gradient(90deg, var(--gray-100) 25%, var(--gray-200) 50%, var(--gray-100) 75%); background-size: 200% 100%; animation: shimmer 1.4s infinite; border-radius: 6px; display: inline-block; }
    @keyframes shimmer { from { background-position: 200% 0; } to { background-position: -200% 0; } }

    @media (max-width: 900px) { .sidebar { display: none; } .main { padding: 20px 16px; } }

    /* â”€â”€ MODE PDF â€” couleurs forcees plus foncees et contrastÃ©es pour meilleur rendu â”€â”€ */
    .pdf-mode .doc-company-name   { color: #000000 !important; }
    .pdf-mode .doc-company-info   { color: #000000 !important; }
    .pdf-mode .doc-quote-label    { color: #000000 !important; }
    .pdf-mode .doc-quote-number   { color: #EA6C0A !important; }
    .pdf-mode .doc-quote-dates    { color: #000000 !important; }
    .pdf-mode .doc-quote-dates strong { color: #000000 !important; }
    .pdf-mode .doc-section-title  { color: #000000 !important; }
    .pdf-mode .doc-client-box     { background: #DDDDDD !important; border-left-color: #EA6C0A !important; }
    .pdf-mode .doc-client-name    { color: #000000 !important; }
    .pdf-mode .doc-client-info    { color: #000000 !important; }
    .pdf-mode .doc-table thead tr { background: #000000 !important; }
    .pdf-mode .doc-table thead th { color: #FFFFFF !important; }
    .pdf-mode .doc-table tbody td { color: #000000 !important; }
    .pdf-mode .doc-table tbody td.desc  { color: #000000 !important; font-weight: 600 !important; }
    .pdf-mode .doc-table tbody td.right { color: #000000 !important; }
    .pdf-mode .doc-table tbody tr { border-bottom: 1px solid #000000 !important; }
    .pdf-mode .doc-table tfoot .label { color: #000000 !important; }
    .pdf-mode .doc-table tfoot .value { color: #000000 !important; }
    .pdf-mode .doc-table tfoot .total-label { color: #000000 !important; }
    .pdf-mode .doc-table tfoot .total-value { color: #EA6C0A !important; }
    .pdf-mode .doc-notes   { background: #DDDDDD !important; }
    .pdf-mode .doc-notes p { color: #000000 !important; }
    .pdf-mode .doc-header  { background: #FFFFFF !important; border-bottom: 2px solid #000000 !important; }
    .pdf-mode .doc-footer  { background: #DDDDDD !important; border-top: 2px solid #000000 !important; }
    .pdf-mode .doc-footer-text  { color: #000000 !important; }
    .pdf-mode .doc-footer-brand { color: #EA6C0A !important; }
  </style>
</head>

<body>

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-logo">
      <div class="sidebar-logo-icon">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
      </div>
      <span>Devis App</span>
    </div>
    <nav class="sidebar-nav">
      <span class="nav-section-label">Menu</span>
      <a href="dashboard.html" class="nav-link">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
        Dashboard
      </a>
      <a href="quotes.html" class="nav-link active">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
        Devis crÃ©es
      </a>
      <a href="clients.html" class="nav-link">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>
        Clients
      </a>
      <span class="nav-section-label" style="margin-top:8px;">Compte</span>
      <a href="settings.html" class="nav-link">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
        ParamÃ¨tres
      </a>
    </nav>
    <div class="sidebar-footer">
      <div class="user-card">
        <div class="user-avatar" id="userAvatar">?</div>
        <div>
          <div class="user-name" id="sidebarName">Chargement...</div>
          <div class="user-role" id="sidebarCompany">â€”</div>
        </div>
      </div>
      <button class="btn-logout" id="logoutBtn">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
        DÃ©connexion
      </button>
    </div>
  </aside>

  <!-- Main -->
  <main class="main">

    <div class="page-header">
      <div>
        <h1 class="page-title">Mes devis</h1>
        <p class="page-subtitle" id="quotesSubtitle">Chargement...</p>
      </div>
      <a href="create-quote.html" class="btn-new">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        Nouveau devis
      </a>
    </div>

    <!-- Filtres -->
    <div class="filters-bar">
      <div class="search-wrap">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>
        <input type="text" class="search-input" id="searchInput" placeholder="Rechercher par client ou numÃ©ro...">
      </div>
      <button class="filter-btn active" data-filter="all">Tous</button>
      <button class="filter-btn" data-filter="draft">Brouillon</button>
      <button class="filter-btn" data-filter="sent">EnvoyÃ©</button>
      <button class="filter-btn" data-filter="accepted">AcceptÃ©</button>
      <button class="filter-btn" data-filter="rejected">RefusÃ©</button>
    </div>

    <!-- Table -->
    <div class="card">
      <div class="table-wrap">
        <table>
          <thead>
            <tr>
              <th>NÂ° Devis</th>
              <th>Client</th>
              <th>Date</th>
              <th>Statut</th>
              <th>Total TTC</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="quotesTable">
            <tr><td colspan="6"><div class="skeleton" style="height:44px;margin:8px 0;width:100%;"></div></td></tr>
            <tr><td colspan="6"><div class="skeleton" style="height:44px;margin:8px 0;width:100%;"></div></td></tr>
            <tr><td colspan="6"><div class="skeleton" style="height:44px;margin:8px 0;width:100%;"></div></td></tr>
          </tbody>
        </table>
      </div>
    </div>

  </main>

  <!-- Hidden Quote Doc for PDF Generation -->
  <div id="hiddenQuoteDoc" class="quote-doc" style="display:none; position:absolute; left:-9999px; width:800px;">
    <!-- En-tÃªte -->
    <div class="doc-header">
      <div>
        <div class="doc-company-name" id="docCompanyName">â€”</div>
        <div class="doc-company-info" id="docCompanyInfo">â€”</div>
      </div>
      <div class="doc-quote-info">
        <div class="doc-quote-label">Devis</div>
        <div class="doc-quote-number" id="docQuoteNumber">â€”</div>
        <div class="doc-quote-dates" id="docQuoteDates">â€”</div>
      </div>
    </div>

    <!-- Corps -->
    <div class="doc-body">

      <!-- Client -->
      <div class="doc-section-title">AdressÃ© Ã </div>
      <div class="doc-client-box">
        <div class="doc-client-name" id="docClientName">â€”</div>
        <div class="doc-client-info" id="docClientInfo">â€”</div>
      </div>

      <!-- Lignes -->
      <table class="doc-table">
        <thead>
          <tr>
            <th style="width:50%">Description</th>
            <th class="right" style="width:14%">QuantitÃ©</th>
            <th class="right" style="width:18%">Prix unitaire</th>
            <th class="right" style="width:18%">Total HT</th>
          </tr>
        </thead>
        <tbody id="docItems"></tbody>
        <tfoot id="docTotals"></tfoot>
      </table>

      <!-- Notes -->
      <div id="docNotesWrap" style="display:none;">
        <div class="doc-section-title">Notes et conditions</div>
        <div class="doc-notes">
          <p id="docNotes"></p>
        </div>
      </div>

    </div>

    <!-- Footer document -->
    <div class="doc-footer">
      <div class="doc-footer-text">Merci de votre confiance.</div>
      <div class="doc-footer-brand" id="docFooterBrand">Devis App</div>
    </div>
  </div>

  <!-- Modal suppression -->
  <div class="modal-overlay" id="deleteModal">
    <div class="modal">
      <div class="modal-icon red">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 01-2 2H8a2 2 0 01-2-2L5 6"/><path d="M10 11v6"/><path d="M14 11v6"/></svg>
      </div>
      <h3>Supprimer ce devis ?</h3>
      <p id="deleteModalText">Cette action est irrÃ©versible.</p>
      <div class="modal-actions">
        <button class="btn-modal-cancel" id="cancelDelete">Annuler</button>
        <button class="btn-modal-confirm-red" id="confirmDelete">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 01-2 2H8a2 2 0 01-2-2L5 6"/></svg>
          Supprimer
        </button>
      </div>
    </div>
  </div>

  <!-- Modal statut -->
  <div class="modal-overlay" id="statusModal">
    <div class="modal">
      <div class="modal-icon orange">
        <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
      </div>
      <h3>Changer le statut</h3>
      <p>SÃ©lectionnez le nouveau statut pour ce devis.</p>
      <div class="status-options">
        <button class="status-option" data-status="draft">ğŸ“ Brouillon</button>
        <button class="status-option" data-status="sent">ğŸ“¤ EnvoyÃ©</button>
        <button class="status-option" data-status="accepted">âœ… AcceptÃ©</button>
        <button class="status-option" data-status="rejected">âŒ RefusÃ©</button>
        <button class="status-option" data-status="expired">â° ExpirÃ©</button>
      </div>
      <div class="modal-actions">
        <button class="btn-modal-cancel" id="cancelStatus">Annuler</button>
      </div>
    </div>
  </div>

<script type="module">
import { createClient } from 'https://esm.sh/@supabase/supabase-js'

const supabase = createClient(
  'https://xeezdzbotsblzclnmnxg.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhlZXpkemJvdHNibHpjbG5tbnhnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0NDk3NTQsImV4cCI6MjA4NjAyNTc1NH0.RHIGavm6M9WCR6nve1Iz_JKFeQRlpRCU2FNAr9E02PM'
)

const fmt = (n) => new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'XOF' }).format(n || 0)
const fmtDate = (d) => d ? new Date(d).toLocaleDateString('fr-FR') : 'â€”'

let currentUserId  = null
let allQuotes      = []
let currentFilter  = 'all'
let quoteToDelete  = null
let quoteToStatus  = null

// â”€â”€ Toast â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showToast(msg, type = 'success') {
  document.querySelector('.toast')?.remove()
  const t = document.createElement('div')
  t.className = `toast ${type}`
  t.innerHTML = type === 'success'
    ? `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg> ${msg}`
    : `<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg> ${msg}`
  document.body.appendChild(t)
  setTimeout(() => t.remove(), 3500)
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
  const { data: { session } } = await supabase.auth.getSession()
  if (!session) { window.location.href = 'login.html'; return }
  currentUserId = session.user.id
  await loadUserProfile(session.user.id)
  await loadQuotes()
}

// â”€â”€ Profil sidebar â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadUserProfile(userId) {
  const { data } = await supabase.from('profiles').select('first_name, last_name, company').eq('id', userId).single()
  if (data) {
    const initials = [data.first_name?.[0], data.last_name?.[0]].filter(Boolean).join('').toUpperCase() || 'U'
    document.getElementById('userAvatar').textContent = initials
    document.getElementById('sidebarName').textContent = [data.first_name, data.last_name].filter(Boolean).join(' ') || 'Utilisateur'
    document.getElementById('sidebarCompany').textContent = data.company || 'Mon entreprise'
  }
}

// â”€â”€ Chargement devis â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadQuotes() {
  const { data, error } = await supabase
    .from('quotes')
    .select(`id, quote_number, created_at, status, total_amount, clients(id, full_name, email, phone)`)
    .eq('user_id', currentUserId)
    .order('created_at', { ascending: false })

  if (error) { showToast('Erreur chargement devis', 'error'); return }
  allQuotes = data || []
  applyFilters()
}

// â”€â”€ Filtre + recherche â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function applyFilters() {
  const q = document.getElementById('searchInput').value.toLowerCase()
  let filtered = allQuotes

  if (currentFilter !== 'all') filtered = filtered.filter(d => d.status === currentFilter)
  if (q) filtered = filtered.filter(d =>
    d.clients?.full_name?.toLowerCase().includes(q) ||
    d.quote_number?.toLowerCase().includes(q)
  )
  renderQuotes(filtered)
}

// â”€â”€ Badge statut â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function statusBadge(status) {
  const map = {
    draft:    ['badge-draft',    'Brouillon'],
    sent:     ['badge-sent',     'EnvoyÃ©'],
    accepted: ['badge-accepted', 'AcceptÃ©'],
    rejected: ['badge-rejected', 'RefusÃ©'],
    expired:  ['badge-expired',  'ExpirÃ©'],
  }
  const [cls, label] = map[status] || map.draft
  return `<span class="badge ${cls}">${label}</span>`
}

// â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderQuotes(quotes) {
  const tbody = document.getElementById('quotesTable')
  const count = allQuotes.length

  document.getElementById('quotesSubtitle').textContent =
    `${count} devis au total â€” ${allQuotes.filter(d => d.status === 'accepted').length} acceptÃ©s`

  if (!quotes.length) {
    tbody.innerHTML = `
      <tr><td colspan="6">
        <div class="empty-state">
          <div class="empty-icon">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
          </div>
          <h3>Aucun devis trouvÃ©</h3>
          <p>${currentFilter === 'all' ? 'CrÃ©ez votre premier devis.' : 'Aucun devis avec ce statut.'}</p>
          ${currentFilter === 'all' ? `<a href="create-quote.html" class="btn-new" style="margin-top:16px;">+ Nouveau devis</a>` : ''}
        </div>
      </td></tr>`
    return
  }

  tbody.innerHTML = quotes.map(q => `
    <tr data-id="${q.id}">
      <td><span class="quote-number">${q.quote_number || 'â€”'}</span></td>
      <td>${q.clients?.full_name || '<span style="color:var(--gray-400)">â€”</span>'}</td>
      <td style="color:var(--gray-500);font-size:13px;">${fmtDate(q.created_at)}</td>
      <td>${statusBadge(q.status)}</td>
      <td><span class="total-amount">${fmt(q.total_amount)}</span></td>
      <td>
        <div class="actions-cell">
          <a href="view-quote.html?id=${q.id}" class="btn-action btn-view" title="Voir le devis">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
            Voir
          </a>
          <button class="btn-action btn-email" title="Envoyer par email">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
            Email
          </button>
          <button class="btn-action btn-whatsapp" title="Envoyer par WhatsApp">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 11.5a8.38 8.38 0 01-.9 3.8 8.5 8.5 0 01-7.6 4.7 8.38 8.38 0 01-3.8-.9L3 21l1.9-5.7a8.38 8.38 0 01-.9-3.8 8.5 8.5 0 014.7-7.6 8.38 8.38 0 013.8-.9h.5a8.48 8.48 0 018 8v.5z"/></svg>
            WhatsApp
          </button>
          <button class="btn-action btn-status"
            data-id="${q.id}" data-status="${q.status}"
            title="Changer le statut">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
          </button>
          <button class="btn-action btn-delete-sm"
            data-id="${q.id}" data-number="${q.quote_number || 'ce devis'}"
            title="Supprimer">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="3 6 5 6 21 6"/><path d="M19 6l-1 14a2 2 0 01-2 2H8a2 2 0 01-2-2L5 6"/></svg>
          </button>
        </div>
      </td>
    </tr>
  `).join('')

  attachRowEvents()
}

// â”€â”€ Events sur les lignes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function attachRowEvents() {

  // Email
  document.querySelectorAll('.btn-email').forEach(btn => {
    btn.addEventListener('click', async () => {
      const row = btn.closest('tr')
      const id = row.dataset.id
      await sharePdfWithMessage(btn, true, id)
    })
  })

  // WhatsApp
  document.querySelectorAll('.btn-whatsapp').forEach(btn => {
    btn.addEventListener('click', async () => {
      const row = btn.closest('tr')
      const id = row.dataset.id
      await sharePdfWithMessage(btn, false, id)
    })
  })

  // Statut
  document.querySelectorAll('.btn-status').forEach(btn => {
    btn.addEventListener('click', () => {
      quoteToStatus = btn.dataset.id
      // Highlight le statut actuel
      document.querySelectorAll('.status-option').forEach(opt => {
        opt.classList.toggle('selected', opt.dataset.status === btn.dataset.status)
      })
      document.getElementById('statusModal').classList.add('show')
    })
  })

  // Suppression
  document.querySelectorAll('.btn-delete-sm').forEach(btn => {
    btn.addEventListener('click', () => {
      quoteToDelete = btn.dataset.id
      document.getElementById('deleteModalText').textContent =
        `Voulez-vous vraiment supprimer le devis NÂ°${btn.dataset.number} ? Cette action est irrÃ©versible.`
      document.getElementById('deleteModal').classList.add('show')
    })
  })
}

// â”€â”€ Mise Ã  jour statut â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function updateStatus(id, status, showFeedback = true) {
  const { error } = await supabase.from('quotes').update({ status }).eq('id', id)
  if (error) { showToast('Erreur mise Ã  jour statut', 'error'); return }
  if (showFeedback) showToast('Statut mis Ã  jour !')
  await loadQuotes()
}

// â”€â”€ Events modals â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('confirmDelete').addEventListener('click', async () => {
  if (!quoteToDelete) return
  document.getElementById('deleteModal').classList.remove('show')
  const { error } = await supabase.from('quotes').delete().eq('id', quoteToDelete)
  if (error) { showToast('Erreur suppression', 'error'); return }
  showToast('Devis supprimÃ©.')
  quoteToDelete = null
  await loadQuotes()
})
document.getElementById('cancelDelete').addEventListener('click', () => {
  document.getElementById('deleteModal').classList.remove('show')
  quoteToDelete = null
})
document.getElementById('cancelStatus').addEventListener('click', () => {
  document.getElementById('statusModal').classList.remove('show')
  quoteToStatus = null
})
document.querySelectorAll('.status-option').forEach(opt => {
  opt.addEventListener('click', () => {
    document.getElementById('statusModal').classList.remove('show')
    if (quoteToStatus) updateStatus(quoteToStatus, opt.dataset.status)
    quoteToStatus = null
  })
})

// Fermer modals en cliquant dehors
document.querySelectorAll('.modal-overlay').forEach(overlay => {
  overlay.addEventListener('click', (e) => {
    if (e.target === e.currentTarget) {
      e.currentTarget.classList.remove('show')
      quoteToDelete = null; quoteToStatus = null
    }
  })
})

// â”€â”€ Filtres â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll('.filter-btn').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'))
    btn.classList.add('active')
    currentFilter = btn.dataset.filter
    applyFilters()
  })
})
document.getElementById('searchInput').addEventListener('input', applyFilters)

// â”€â”€ Logout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('logoutBtn').addEventListener('click', async () => {
  await supabase.auth.signOut()
  window.location.href = 'login.html'
})

// â”€â”€ Fonction PDF haute qualite (partagee par Telecharger et WhatsApp) â”€â”€â”€â”€â”€â”€â”€â”€â”€
// returnBlob=false -> sauvegarde le fichier directement
// returnBlob=true  -> retourne un Blob pour Web Share API
async function generatePdf(returnBlob, elemId = 'hiddenQuoteDoc') {
  const { jsPDF } = window.jspdf
  const elem       = document.getElementById(elemId)
  const filename   = 'Devis-' + (quoteData ? quoteData.quote_number : 'devis') + '.pdf'

  elem.classList.add('pdf-mode')

  try {
    await document.fonts.ready;
    await new Promise(function(r){ setTimeout(r, 300) })

    const canvas = await html2canvas(elem, {
      scale           : 2,
      useCORS         : true,
      allowTaint      : false,
      backgroundColor : '#ffffff',
      logging         : false,
      imageTimeout    : 0,
      removeContainer : true,
      letterRendering : true,
      windowWidth     : elem.scrollWidth,
      windowHeight    : elem.scrollHeight
    })

    const imgData = canvas.toDataURL('image/jpeg', 0.7)

    const pdf   = new jsPDF({ orientation: 'portrait', unit: 'mm', format: 'a4', compress: true })
    const pageW = pdf.internal.pageSize.getWidth()   // 210 mm
    const pageH = pdf.internal.pageSize.getHeight()  // 297 mm
    const imgH  = (canvas.height / canvas.width) * pageW

    var yOff  = 0
    var leftH = imgH
    while (leftH > 0) {
      pdf.addImage(imgData, 'JPEG', 0, yOff, pageW, imgH, '', 'FAST')
      leftH -= pageH
      yOff  -= pageH
      if (leftH > 0) pdf.addPage()
    }

    if (returnBlob) return pdf.output('blob')
    pdf.save(filename)

  } finally {
    elem.classList.remove('pdf-mode')
  }
}

// â”€â”€ Render Quote for PDF â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function renderQuoteForPdf(id) {
  const { data: fullQuote, error } = await supabase
    .from('quotes')
    .select(`
      *,
      clients(*),
      quote_items(*)
    `)
    .eq('id', id)
    .single()

  if (error || !fullQuote) {
    showToast('Erreur chargement devis', 'error')
    return null
  }

  const client = fullQuote.clients || {}
  const items  = fullQuote.quote_items || []

  // Infos entreprise (depuis profil)
  const { data: profile } = await supabase.from('profiles').select('company, address, city, country, phone').eq('id', currentUserId).single()
  document.getElementById('docCompanyName').textContent = profile.company || 'Mon entreprise'
  const companyInfo = [
    profile.address,
    profile.city,
    profile.country,
    profile.phone
  ].filter(Boolean).join('\n')
  document.getElementById('docCompanyInfo').innerHTML = companyInfo.replace(/\n/g, '<br>') || 'â€”'

  // En-tÃªte document
  document.getElementById('docQuoteNumber').textContent = fullQuote.quote_number || 'â€”'
  document.getElementById('docQuoteDates').innerHTML =
    `<strong>Date :</strong> ${fmtDate(fullQuote.created_at)}`

  // Client
  document.getElementById('docClientName').textContent = client.full_name || 'â€”'
  const clientInfo = [
    client.company_name,
    client.address,
    [client.postal_code, client.city].filter(Boolean).join(' '),
    client.country,
    client.email,
    client.phone
  ].filter(Boolean).join('\n')
  document.getElementById('docClientInfo').innerHTML = clientInfo.replace(/\n/g, '<br>') || 'â€”'

  // Lignes
  const tbody = document.getElementById('docItems')
  if (!items.length) {
    tbody.innerHTML = `<tr><td colspan="4" style="text-align:center;color:var(--gray-400);padding:20px;">Aucune ligne</td></tr>`
  } else {
    tbody.innerHTML = items.map(item => `
      <tr>
        <td class="desc">${item.description || 'â€”'}</td>
        <td class="right">${item.quantity}</td>
        <td class="right">${fmt(item.unit_price)}</td>
        <td class="right">${fmt(item.total)}</td>
      </tr>
    `).join('')
  }

  // Totaux
  document.getElementById('docTotals').innerHTML = `
    <tr>
      <td colspan="2"></td>
      <td class="label">Sous-total HT</td>
      <td class="value">${fmt(fullQuote.subtotal)}</td>
    </tr>
    <tr>
      <td colspan="2"></td>
      <td class="label">TVA (${fullQuote.tax_rate || 0}%)</td>
      <td class="value">${fmt(fullQuote.tax_amount)}</td>
    </tr>
    <tr class="total-row">
      <td colspan="2"></td>
      <td class="total-label">Total TTC</td>
      <td class="total-value">${fmt(fullQuote.total_amount)}</td>
    </tr>
  `

  // Notes
  if (fullQuote.notes) {
    document.getElementById('docNotesWrap').style.display = 'block'
    document.getElementById('docNotes').textContent = fullQuote.notes
  } else {
    document.getElementById('docNotesWrap').style.display = 'none'
  }

  // Retourne les infos pour le message
  return {
    clientName: client.full_name || '',
    clientEmail: client.email || '',
    clientPhone: client.phone || '',
    number: fullQuote.quote_number || '',
    amount: fmt(fullQuote.total_amount),
  }
}

// â”€â”€ Fonction partagÃ©e pour gÃ©nÃ©rer et partager le PDF â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function sharePdfWithMessage(button, isEmail = false, quoteId) {
  button.disabled = true
  const origHtml = button.innerHTML
  button.innerHTML = '<svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="animation:spin 0.7s linear infinite;display:inline-block"><path d="M21 12a9 9 0 11-6.219-8.56"/></svg>'

  const quoteInfo = await renderQuoteForPdf(quoteId)
  if (!quoteInfo) {
    button.disabled = false
    button.innerHTML = origHtml
    return
  }

  let pdfBlob = null
  try {
    pdfBlob = await generatePdf(true)
  } catch(e) {
    showToast('Erreur gÃ©nÃ©ration PDF.', 'error')
    button.disabled = false
    button.innerHTML = origHtml
    return
  }

  const filename = 'Devis-' + quoteInfo.number + '.pdf'

  const messageText = `Bonjour ${quoteInfo.clientName} ğŸ‘‹,\n\nVeuillez trouver ci-joint votre devis NÂ°${quoteInfo.number} d'un montant de ${quoteInfo.amount} TTC ğŸ“„.\n\nN'hÃ©sitez pas Ã  me contacter pour toute question ğŸ˜Š.\n\nCordialement`;

  const pdfFile = new File([pdfBlob], filename, { type: 'application/pdf' })

  if (navigator.canShare && navigator.canShare({ files: [pdfFile] })) {
    try {
      await navigator.share({
        title: `Devis NÂ°${quoteInfo.number}`,
        text: messageText,
        files: [pdfFile]
      })
      updateStatus(quoteId, 'sent', false)
      showToast('Devis partagÃ© avec succÃ¨s !')
    } catch(err) {
      if (err.name !== 'AbortError') showToast('Partage annulÃ©.', 'error')
    }
  } else {
    const url = URL.createObjectURL(pdfBlob)
    const a = document.createElement('a')
    a.href = url
    a.download = filename
    a.click()
    setTimeout(() => URL.revokeObjectURL(url), 1000)

    if (isEmail) {
      if (quoteInfo.clientEmail) {
        const subject = encodeURIComponent(`Devis NÂ°${quoteInfo.number}`)
        const body = encodeURIComponent(messageText)
        window.open(`mailto:${quoteInfo.clientEmail}?subject=${subject}&body=${body}`)
        showToast('ğŸ“„ PDF tÃ©lÃ©chargÃ© â€” joignez-le dans l\'email.')
      } else {
        showToast('Aucun email enregistrÃ© pour ce client.', 'error')
      }
    } else {
      const cleanPhone = quoteInfo.clientPhone.replace(/[\s\-\(\)]/g, '').replace(/^\+/, '')
      if (cleanPhone) {
        window.open(`https://wa.me/${cleanPhone}?text=${encodeURIComponent(messageText)}`)
        showToast('ğŸ“„ PDF tÃ©lÃ©chargÃ© â€” joignez-le dans WhatsApp.')
      } else {
        showToast('Aucun numÃ©ro WhatsApp enregistrÃ© pour ce client.', 'error')
      }
    }
    updateStatus(quoteId, 'sent', false)
  }

  button.disabled = false
  button.innerHTML = origHtml
}

// â”€â”€ Logout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('logoutBtn').addEventListener('click', async () => {
  await supabase.auth.signOut()
  window.location.href = 'login.html'
})

init()
</script>

</body>
</html>