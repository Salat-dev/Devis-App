<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, minimum-scale=1.0">
  <title>Nouveau Devis - Devis App</title>
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;600;700;800&family=DM+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --orange: #F97316;
      --orange-dark: #EA6C0A;
      --orange-light: #FEF3E7;
      --gray-50: #F9FAFB;
      --gray-100: #F3F4F6;
      --gray-200: #E5E7EB;
      --gray-300: #D1D5DB;
      --gray-400: #9CA3AF;
      --gray-500: #6B7280;
      --gray-600: #4B5563;
      --gray-700: #374151;
      --gray-800: #1F2937;
      --gray-900: #111827;
      --green: #10B981;
      --green-light: #D1FAE5;
      --blue: #3B82F6;
      --blue-light: #EFF6FF;
      --red: #EF4444;
      --red-light: #FFF1F1;
      --white: #FFFFFF;
    }

    body {
      font-family: 'DM Sans', sans-serif;
      background: var(--gray-100);
      min-height: 100vh;
      display: flex;
    }

    /* ── Sidebar ── */
    .sidebar {
      width: 260px;
      min-width: 260px;
      background: var(--gray-900);
      display: flex;
      flex-direction: column;
      height: 100vh;
      position: sticky;
      top: 0;
    }
    .sidebar-logo {
      padding: 24px 20px;
      border-bottom: 1px solid rgba(255,255,255,0.07);
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .sidebar-logo-icon {
      width: 36px; height: 36px;
      background: var(--orange);
      border-radius: 10px;
      display: flex; align-items: center; justify-content: center;
      flex-shrink: 0;
    }
    .sidebar-logo span {
      font-family: 'Syne', sans-serif;
      font-size: 18px; font-weight: 800;
      color: white;
    }
    .sidebar-nav {
      flex: 1;
      padding: 16px 12px;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    .nav-section-label {
      font-size: 10px; font-weight: 700;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: rgba(255,255,255,0.3);
      padding: 12px 12px 6px;
    }
    .nav-link {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 10px;
      color: rgba(255,255,255,0.55);
      text-decoration: none;
      font-size: 14px; font-weight: 500;
      transition: all 0.2s;
    }
    .nav-link:hover { background: rgba(255,255,255,0.07); color: rgba(255,255,255,0.9); }
    .nav-link.active { background: rgba(249,115,22,0.15); color: var(--orange); }
    .sidebar-footer {
      padding: 16px 12px;
      border-top: 1px solid rgba(255,255,255,0.07);
    }
    .user-card {
      display: flex; align-items: center; gap: 10px;
      padding: 10px 12px;
      border-radius: 10px;
      margin-bottom: 8px;
      background: rgba(255,255,255,0.05);
    }
    .user-avatar {
      width: 34px; height: 34px;
      border-radius: 50%;
      background: var(--orange);
      display: flex; align-items: center; justify-content: center;
      font-family: 'Syne', sans-serif;
      font-size: 13px; font-weight: 700;
      color: white; flex-shrink: 0;
    }
    .user-name { font-size: 13px; font-weight: 600; color: white; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .user-role { font-size: 11px; color: rgba(255,255,255,0.4); }
    .btn-logout {
      width: 100%;
      display: flex; align-items: center; justify-content: center; gap: 8px;
      padding: 9px;
      border-radius: 10px;
      background: rgba(239,68,68,0.1);
      color: #F87171;
      font-family: 'DM Sans', sans-serif;
      font-size: 13px; font-weight: 600;
      border: 1px solid rgba(239,68,68,0.2);
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-logout:hover { background: rgba(239,68,68,0.2); color: #FCA5A5; }

    /* ── Main ── */
    .main {
      flex: 1;
      overflow-y: auto;
      padding: 32px 36px;
    }

    /* Header */
    .page-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 32px;
    }
    .back-link {
      display: inline-flex; align-items: center; gap: 6px;
      font-size: 13px; font-weight: 600;
      color: var(--gray-500);
      text-decoration: none;
      transition: color 0.2s;
      margin-bottom: 10px;
    }
    .back-link:hover { color: var(--orange); }
    .page-title {
      font-family: 'Syne', sans-serif;
      font-size: 26px; font-weight: 800;
      color: var(--gray-800);
    }
    .header-badge {
      display: inline-flex; align-items: center; gap: 6px;
      background: var(--orange-light);
      color: var(--orange);
      font-family: 'Syne', sans-serif;
      font-size: 11px; font-weight: 700;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      padding: 6px 14px;
      border-radius: 100px;
    }

    /* Card */
    .card {
      background: var(--white);
      border-radius: 16px;
      padding: 28px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.04), 0 4px 16px rgba(0,0,0,0.04);
      margin-bottom: 20px;
      animation: slideUp 0.35s ease both;
    }
    .card:nth-child(2) { animation-delay: 0.06s; }
    .card:nth-child(3) { animation-delay: 0.12s; }
    @keyframes slideUp {
      from { opacity: 0; transform: translateY(12px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    .card-title {
      font-family: 'Syne', sans-serif;
      font-size: 14px; font-weight: 700;
      color: var(--gray-700);
      margin-bottom: 20px;
      display: flex; align-items: center; gap: 8px;
    }
    .card-title svg { color: var(--orange); }

    /* Grille form */
    .form-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 16px; }
    .col-2 { grid-column: span 2; }

    .field-group { display: flex; flex-direction: column; gap: 6px; }
    .field-group label {
      font-size: 12px; font-weight: 600;
      color: var(--gray-600);
      letter-spacing: 0.02em;
    }
    .field-group label span { color: var(--red); margin-left: 2px; }

    select, input[type="number"], input[type="text"], textarea {
      width: 100%;
      border: 1.5px solid var(--gray-200);
      border-radius: 10px;
      padding: 10px 14px;
      font-family: 'DM Sans', sans-serif;
      font-size: 14px;
      color: var(--gray-800);
      background: var(--gray-50);
      transition: border-color 0.2s, box-shadow 0.2s, background 0.2s;
      outline: none;
      appearance: none;
    }
    select { background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%239CA3AF' stroke-width='2'%3E%3Cpolyline points='6 9 12 15 18 9'/%3E%3C/svg%3E"); background-repeat: no-repeat; background-position: right 12px center; padding-right: 36px; }
    input:focus, select:focus, textarea:focus {
      border-color: var(--orange);
      background: var(--white);
      box-shadow: 0 0 0 3px rgba(249,115,22,0.1);
    }

    /* Table lignes */
    .items-table-wrap { overflow-x: auto; }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    thead tr {
      border-bottom: 2px solid var(--gray-100);
    }
    thead th {
      font-size: 11px; font-weight: 700;
      color: var(--gray-500);
      letter-spacing: 0.06em;
      text-transform: uppercase;
      padding: 8px 10px;
      text-align: left;
    }
    thead th.right { text-align: right; }

    tbody tr {
      border-bottom: 1px solid var(--gray-100);
      transition: background 0.15s;
    }
    tbody tr:hover { background: var(--gray-50); }

    tbody td { padding: 8px 10px; vertical-align: middle; }
    tbody td.right { text-align: right; }

    tbody input {
      border-radius: 8px;
      padding: 8px 10px;
      font-size: 14px;
    }
    tbody input[type="number"] { text-align: right; }

    .line-total {
      font-family: 'Syne', sans-serif;
      font-size: 14px; font-weight: 700;
      color: var(--gray-800);
      text-align: right;
      min-width: 80px;
    }

    .btn-remove-row {
      width: 30px; height: 30px;
      border-radius: 8px;
      border: none;
      background: var(--red-light);
      color: var(--red);
      cursor: pointer;
      display: flex; align-items: center; justify-content: center;
      transition: all 0.2s;
      margin: 0 auto;
    }
    .btn-remove-row:hover { background: var(--red); color: white; }

    /* Bouton ajouter ligne */
    .btn-add-row {
      display: inline-flex; align-items: center; gap: 8px;
      margin-top: 16px;
      padding: 9px 18px;
      border-radius: 10px;
      border: 1.5px dashed var(--gray-300);
      background: none;
      color: var(--gray-500);
      font-family: 'DM Sans', sans-serif;
      font-size: 13px; font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-add-row:hover { border-color: var(--orange); color: var(--orange); background: var(--orange-light); }

    /* Totaux */
    .totals-wrap {
      margin-top: 20px;
      display: flex;
      justify-content: flex-end;
    }
    .totals-box {
      background: var(--gray-50);
      border-radius: 12px;
      padding: 20px 24px;
      min-width: 280px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .total-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 14px;
      color: var(--gray-600);
    }
    .total-row.main {
      padding-top: 10px;
      border-top: 2px solid var(--gray-200);
      font-family: 'Syne', sans-serif;
      font-size: 18px; font-weight: 800;
      color: var(--gray-800);
    }
    .total-row span:last-child { font-weight: 700; color: var(--gray-800); }
    .total-row.main span:last-child { color: var(--orange); }

    /* Actions footer */
    .actions-bar {
      display: flex;
      justify-content: flex-end;
      gap: 12px;
      margin-top: 8px;
    }
    .btn-cancel {
      padding: 11px 24px;
      border-radius: 10px;
      border: 1.5px solid var(--gray-200);
      background: var(--gray-100);
      color: var(--gray-600);
      font-family: 'DM Sans', sans-serif;
      font-size: 14px; font-weight: 600;
      cursor: pointer;
      text-decoration: none;
      display: inline-flex; align-items: center;
      transition: all 0.2s;
    }
    .btn-cancel:hover { background: var(--gray-200); }

    .btn-save {
      padding: 11px 28px;
      border-radius: 10px;
      border: none;
      background: var(--green);
      color: white;
      font-family: 'DM Sans', sans-serif;
      font-size: 14px; font-weight: 700;
      cursor: pointer;
      display: inline-flex; align-items: center; gap: 8px;
      box-shadow: 0 4px 12px rgba(16,185,129,0.3);
      transition: all 0.2s;
    }
    .btn-save:hover { filter: brightness(1.05); transform: translateY(-1px); }
    .btn-save:disabled { opacity: 0.6; cursor: not-allowed; transform: none; }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 28px; right: 28px;
      padding: 14px 20px;
      border-radius: 12px;
      font-size: 14px; font-weight: 600;
      display: flex; align-items: center; gap: 10px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.12);
      animation: toastIn 0.3s ease;
      z-index: 999;
      max-width: 360px;
    }
    .toast.success { background: var(--green); color: white; }
    .toast.error   { background: var(--red);   color: white; }
    @keyframes toastIn {
      from { opacity: 0; transform: translateY(12px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    /* Loader */
    @keyframes spin { to { transform: rotate(360deg); } }
    .spinner {
      width: 16px; height: 16px;
      border: 2px solid rgba(255,255,255,0.4);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 0.7s linear infinite;
    }

    @media (max-width: 900px) {
      .sidebar { display: none; }
      .main { padding: 20px 16px; }
      .form-grid { grid-template-columns: 1fr; }
      .col-2 { grid-column: span 1; }
    }
  </style>
</head>

<body>

  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="sidebar-logo">
      <div class="sidebar-logo-icon">
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
      </div>
      <span>Devis App</span>
    </div>
    <nav class="sidebar-nav">
      <span class="nav-section-label">Menu</span>
      <a href="dashboard.html" class="nav-link">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg>
        Dashboard
      </a>
      <a href="create-quote.html" class="nav-link active">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
        Devis
      </a>
      <a href="clients.html" class="nav-link">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>
        Clients
      </a>
      <span class="nav-section-label" style="margin-top:8px;">Compte</span>
      <a href="settings.html" class="nav-link">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>
        Paramètres
      </a>
    </nav>
    <div class="sidebar-footer">
      <div class="user-card">
        <div class="user-avatar" id="userAvatar">?</div>
        <div>
          <div class="user-name" id="sidebarName">Chargement...</div>
          <div class="user-role" id="sidebarCompany">—</div>
        </div>
      </div>
      <button class="btn-logout" id="logoutBtn">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 21H5a2 2 0 01-2-2V5a2 2 0 012-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>
        Déconnexion
      </button>
    </div>
  </aside>

  <!-- Main -->
  <main class="main">

    <a href="dashboard.html" class="back-link">
      <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><polyline points="15 18 9 12 15 6"/></svg>
      Retour au dashboard
    </a>

    <div class="page-header">
      <h1 class="page-title">Nouveau devis</h1>
      <div class="header-badge">
        <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
        Devis App
      </div>
    </div>

    <!-- Infos générales -->
    <div class="card">
      <div class="card-title">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M17 21v-2a4 4 0 00-4-4H5a4 4 0 00-4 4v2"/><circle cx="9" cy="7" r="4"/></svg>
        Informations générales
      </div>
      <div class="form-grid">
        <div class="field-group">
          <label>Client <span>*</span></label>
          <select id="clientSelect">
            <option value="">Sélectionner un client...</option>
          </select>
        </div>
        <div class="field-group">
          <label>Taux TVA (%)</label>
          <input type="number" id="taxRate" value="20" min="0" max="100" step="0.1">
        </div>
        <div class="field-group col-2">
          <label>Notes / Conditions</label>
          <textarea id="notes" rows="2" placeholder="Conditions de paiement, délais, remarques..." style="resize:vertical;"></textarea>
        </div>
      </div>
    </div>

    <!-- Lignes du devis -->
    <div class="card">
      <div class="card-title">
        <svg width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="8" y1="6" x2="21" y2="6"/><line x1="8" y1="12" x2="21" y2="12"/><line x1="8" y1="18" x2="21" y2="18"/><line x1="3" y1="6" x2="3.01" y2="6"/><line x1="3" y1="12" x2="3.01" y2="12"/><line x1="3" y1="18" x2="3.01" y2="18"/></svg>
        Lignes du devis
      </div>

      <div class="items-table-wrap">
        <table>
          <thead>
            <tr>
              <th style="width:45%">Description</th>
              <th style="width:12%" class="right">Quantité</th>
              <th style="width:16%" class="right">Prix unitaire</th>
              <th style="width:14%" class="right">Total HT</th>
              <th style="width:8%"></th>
            </tr>
          </thead>
          <tbody id="itemsTable"></tbody>
        </table>
      </div>

      <button class="btn-add-row" id="addRowBtn">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        Ajouter une ligne
      </button>

      <!-- Totaux -->
      <div class="totals-wrap">
        <div class="totals-box">
          <div class="total-row">
            <span>Sous-total HT</span>
            <span id="subtotal">0,00 XAF</span>
          </div>
          <div class="total-row">
            <span>TVA (<span id="taxRateDisplay">20</span>%)</span>
            <span id="taxAmount">0,00 XAF</span>
          </div>
          <div class="total-row main">
            <span>Total TTC</span>
            <span id="totalAmount">0,00 XAF</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div class="actions-bar">
      <a href="dashboard.html" class="btn-cancel">Annuler</a>
      <button class="btn-save" id="saveBtn">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>
        Enregistrer le devis
      </button>
    </div>

  </main>

<script type="module">
import { createClient } from 'https://esm.sh/@supabase/supabase-js'

// ─── Client Supabase ──────────────────────────────────────────────────────────
const supabase = createClient(
  'https://xeezdzbotsblzclnmnxg.supabase.co',
  'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhlZXpkemJvdHNibHpjbG5tbnhnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzA0NDk3NTQsImV4cCI6MjA4NjAyNTc1NH0.RHIGavm6M9WCR6nve1Iz_JKFeQRlpRCU2FNAr9E02PM'
)

let currentUserId = null

// ─── Formatage monétaire ──────────────────────────────────────────────────────
const fmt = (n) => new Intl.NumberFormat('fr-FR', { style: 'currency', currency: 'XOF' }).format(n)

// ─── Toast notification ───────────────────────────────────────────────────────
function showToast(message, type = "success") {
  const existing = document.querySelector(".toast")
  if (existing) existing.remove()

  const toast = document.createElement("div")
  toast.className = `toast ${type}`
  toast.innerHTML = type === "success"
    ? `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M22 11.08V12a10 10 0 11-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg> ${message}`
    : `<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg> ${message}`
  document.body.appendChild(toast)
  setTimeout(() => toast.remove(), 3500)
}

// ─── Init ─────────────────────────────────────────────────────────────────────
async function init() {
  const { data: { session } } = await supabase.auth.getSession()
  if (!session) { window.location.href = "login.html"; return }

  currentUserId = session.user.id
  await loadUserProfile(session.user.id)
  await loadClients()
  addRow() // Ligne vide par défaut
}

// ─── Profil sidebar ───────────────────────────────────────────────────────────
async function loadUserProfile(userId) {
  const { data } = await supabase
    .from("profiles")
    .select("first_name, last_name, company")
    .eq("id", userId)
    .single()

  if (data) {
    const initials = [data.first_name?.[0], data.last_name?.[0]].filter(Boolean).join("").toUpperCase() || "U"
    document.getElementById("userAvatar").textContent = initials
    document.getElementById("sidebarName").textContent = [data.first_name, data.last_name].filter(Boolean).join(" ") || "Utilisateur"
    document.getElementById("sidebarCompany").textContent = data.company || "Mon entreprise"
  }
}

// ─── Chargement clients ───────────────────────────────────────────────────────
async function loadClients() {
  const { data, error } = await supabase
    .from("clients")
    .select("id, full_name")
    .eq("user_id", currentUserId)
    .order("full_name")

  const select = document.getElementById("clientSelect")

  if (error || !data?.length) {
    select.innerHTML = `<option value="">Aucun client — <a href="clients.html">en créer un</a></option>`
    return
  }

  data.forEach(client => {
    const opt = document.createElement("option")
    opt.value = client.id
    opt.textContent = client.full_name
    select.appendChild(opt)
  })
}

// ─── Lignes du devis ──────────────────────────────────────────────────────────
function addRow() {
  const tbody = document.getElementById("itemsTable")
  const row = document.createElement("tr")
  row.innerHTML = `
    <td>
      <input type="text" class="description" placeholder="Description de la prestation...">
    </td>
    <td>
      <input type="number" value="1" min="0" step="0.01" class="quantity">
    </td>
    <td>
      <input type="number" value="0" min="0" step="0.01" class="unitPrice">
    </td>
    <td class="line-total right">0,00 XAF</td>
    <td style="text-align:center;">
      <button class="btn-remove-row" title="Supprimer cette ligne">
        <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </td>
  `
  tbody.appendChild(row)

  // Events sur la ligne
  row.querySelectorAll("input").forEach(input => {
    input.addEventListener("input", calculateTotals)
  })
  row.querySelector(".btn-remove-row").addEventListener("click", () => {
    row.remove()
    calculateTotals()
  })

  calculateTotals()
}

// ─── Calcul des totaux ────────────────────────────────────────────────────────
function calculateTotals() {
  let subtotal = 0
  const taxRate = parseFloat(document.getElementById("taxRate").value) || 0

  document.querySelectorAll("#itemsTable tr").forEach(row => {
    const qty   = parseFloat(row.querySelector(".quantity")?.value) || 0
    const price = parseFloat(row.querySelector(".unitPrice")?.value) || 0
    const lineTotal = qty * price
    row.querySelector(".line-total").textContent = fmt(lineTotal)
    subtotal += lineTotal
  })

  const taxAmount   = subtotal * (taxRate / 100)
  const totalAmount = subtotal + taxAmount

  document.getElementById("subtotal").textContent    = fmt(subtotal)
  document.getElementById("taxAmount").textContent   = fmt(taxAmount)
  document.getElementById("totalAmount").textContent = fmt(totalAmount)
  document.getElementById("taxRateDisplay").textContent = taxRate
}

// ─── Sauvegarde ───────────────────────────────────────────────────────────────
async function saveQuote() {
  const clientId = document.getElementById("clientSelect").value
  if (!clientId) { showToast("Veuillez sélectionner un client.", "error"); return }

  const rows = document.querySelectorAll("#itemsTable tr")
  if (!rows.length) { showToast("Ajoutez au moins une ligne au devis.", "error"); return }

  // Vérifie que toutes les lignes ont une description
  let hasEmpty = false
  rows.forEach(row => {
    if (!row.querySelector(".description").value.trim()) hasEmpty = true
  })
  if (hasEmpty) { showToast("Chaque ligne doit avoir une description.", "error"); return }

  const saveBtn = document.getElementById("saveBtn")
  saveBtn.disabled = true
  saveBtn.innerHTML = `<span class="spinner"></span> Enregistrement...`

  // Génération du numéro de devis
  const { data: quoteNumber, error: rpcError } = await supabase
    .rpc("generate_quote_number", { p_user_id: currentUserId })

  const subtotal    = parseFloat(document.getElementById("subtotal").textContent.replace(/[^\d,]/g, "").replace(",", ".")) || 0
  const taxRate     = parseFloat(document.getElementById("taxRate").value) || 0
  const taxAmount   = subtotal * (taxRate / 100)
  const totalAmount = subtotal + taxAmount

  // Insertion du devis
  const { data: quote, error: quoteError } = await supabase
    .from("quotes")
    .insert({
      user_id:      currentUserId,
      client_id:    clientId,
      quote_number: rpcError ? null : quoteNumber,
      subtotal,
      tax_rate:     taxRate,
      tax_amount:   taxAmount,
      total_amount: totalAmount,
      notes:        document.getElementById("notes").value.trim() || null,
      status:       "draft"
    })
    .select()
    .single()

  if (quoteError) {
    console.error("Quote error:", quoteError)
    showToast("Erreur lors de la création du devis : " + quoteError.message, "error")
    saveBtn.disabled = false
    saveBtn.innerHTML = `<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 21H5a2 2 0 01-2-2V5a2 2 0 012-2h11l5 5v11a2 2 0 01-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg> Enregistrer le devis`
    return
  }

  // Insertion des lignes
  const items = []
  rows.forEach(row => {
    items.push({
      quote_id:    quote.id,
      description: row.querySelector(".description").value.trim(),
      quantity:    parseFloat(row.querySelector(".quantity").value) || 0,
      unit_price:  parseFloat(row.querySelector(".unitPrice").value) || 0,
      total:       parseFloat(row.querySelector(".line-total").textContent.replace(/[^\d,]/g, "").replace(",", ".")) || 0
    })
  })

  const { error: itemsError } = await supabase.from("quote_items").insert(items)

  if (itemsError) {
    console.error("Items error:", itemsError)
    showToast("Devis créé mais erreur sur les lignes : " + itemsError.message, "error")
    return
  }

  showToast("Devis enregistré avec succès !")
  setTimeout(() => window.location.href = "dashboard.html", 1500)
}

// ─── Events ───────────────────────────────────────────────────────────────────
document.getElementById("addRowBtn").addEventListener("click", addRow)
document.getElementById("saveBtn").addEventListener("click", saveQuote)
document.getElementById("taxRate").addEventListener("input", calculateTotals)
document.getElementById("logoutBtn").addEventListener("click", async () => {
  await supabase.auth.signOut()
  window.location.href = "login.html"
})

init()
</script>

</body>
</html>